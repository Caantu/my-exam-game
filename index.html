<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìòÂç∑Âç∑ËÄÉÁ†îÂ§ß‰ΩúÊàò</title>
    <link rel="manifest" href="data:application/json,{%22name%22:%22Âç∑Âç∑ËÄÉÁ†îÂ§ß‰ΩúÊàò%22,%22short_name%22:%22ËÄÉÁ†îÂ§ß‰ΩúÊàò%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%234f46e5%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìò%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}">
    <meta name="theme-color" content="#4f46e5">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .countdown {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 15px;
        }
        
        .status-card {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rank-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .rank-badge {
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #92400e;
        }
        
        .stars {
            font-size: 18px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: bold;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-content {
            padding: 15px;
        }
        
        .task-item {
            padding: 10px;
            margin: 8px 0;
            background: #f1f5f9;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-completed {
            background: #dcfce7;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .schedule-item {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }
        
        .schedule-item:last-child {
            border-bottom: none;
        }
        
        .pk-card {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ef4444;
        }
        
        .pk-player {
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 8px;
        }
        
        .pk-task {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .player-rank {
            font-weight: bold;
            color: #059669;
        }
        
        .my-rank {
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
            margin: -8px -15px;
            padding: 8px 15px;
        }
        
        .reward-item {
            background: #fef7ff;
            border: 1px solid #e879f9;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .story-card {
            background: linear-gradient(135deg, #f0f9ff, #dbeafe);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #3b82f6;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374151;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            max-width: 400px;
            margin: 50px auto;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .modal-header {
            background: #4f46e5;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .cat-mood {
            text-align: center;
            font-size: 48px;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .upload-area:hover {
            border-color: #4f46e5;
        }
        
        .upload-area.dragover {
            border-color: #4f46e5;
            background: #f8fafc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üìòÂç∑Âç∑ËÄÉÁ†îÂ§ß‰ΩúÊàò</div>
            <div class="countdown" id="countdown">ÂÄíËÆ°Êó∂ËÆ°ÁÆó‰∏≠...</div>
        </div>
        
        <div class="main-content">
            <!-- Áä∂ÊÄÅÂç°Áâá -->
            <div class="status-card">
                <div class="rank-info">
                    <div>
                        <div class="rank-badge" id="rankBadge">ÈùíÈìú‚Ö¢</div>
                        <div style="margin-top: 5px; font-size: 12px;">ÊéíÂêç <span id="ranking">5555</span></div>
                    </div>
                    <div class="stars" id="starDisplay">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>‚ö°‰ªäÊó•ÊàòÂäõÔºö<span id="todayPower">0</span>/100</div>
                    <div class="cat-mood" style="font-size: 24px;" id="catMood">üòæ</div>
                </div>
                <div style="font-size: 12px; margin-top: 5px;" id="catStatus">Âç∑Âç∑ÂøÉÊÉÖÔºöÈ•øËÇöÂ≠êÁ≠â‰Ω†ÊäïÂñÇ</div>
            </div>
            
            <!-- ‰ªäÊó•‰ªªÂä° -->
            <div class="section">
                <div class="section-header">
                    üî• ‰ªäÊó•‰ªªÂä°
                </div>
                <div class="section-content">
                    <div class="upload-area" id="uploadArea">
                        <div>üì∏ ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†‰ªªÂä°Ê∏ÖÂçï</div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                    <div id="taskList">
                        <div style="text-align: center; color: #6b7280; padding: 20px;">
                            ÂæÖÊãçÁÖßÂΩïÂÖ•‰ªªÂä°
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Âõ∫ÂÆöÊó∂Èó¥ËßÑÂàí -->
            <div class="section">
                <div class="section-header">
                    üï∞Ô∏è Âõ∫ÂÆöÊó∂Èó¥ËßÑÂàí
                    <div style="font-size: 11px; color: #6b7280; margin-left: auto;" id="currentScheduleHint">
                        Ê≠£Âú®Ëé∑ÂèñÂΩìÂâçÊó∂Á®ã...
                    </div>
                </div>
                <div class="section-content">
                    <div class="schedule-item" data-time="08:00-09:00">
                        <span>08:00-09:00</span>
                        <span>Êó©È§ê+ÂçïËØç</span>
                    </div>
                    <div class="schedule-item" data-time="09:00-13:45">
                        <span>09:00-13:45</span>
                        <span>408‰∏ì‰∏öËØæ</span>
                    </div>
                    <div class="schedule-item" data-time="13:45-14:05">
                        <span>13:45-14:05</span>
                        <span>ÂçàÁù°</span>
                    </div>
                    <div class="schedule-item" data-time="14:10-19:30">
                        <span>14:10-19:30</span>
                        <span>Êï∞Â≠¶‰∫å</span>
                    </div>
                    <div class="schedule-item" data-time="19:30-20:20">
                        <span>19:30-20:20</span>
                        <span>ÊôöÈ§ê</span>
                    </div>
                    <div class="schedule-item" data-time="20:20-21:05">
                        <span>20:20-21:05</span>
                        <span>Ëã±ËØ≠Á≤æËØª</span>
                    </div>
                    <div class="schedule-item" data-time="21:10-23:15">
                        <span>21:10-23:15</span>
                        <span>ËÆ°ÁΩë+Êï∞Â≠¶</span>
                    </div>
                    <div class="schedule-item" data-time="23:15-01:00">
                        <span>23:15-01:00</span>
                        <span>Ê¥óÊº±+ÊîøÊ≤ª</span>
                    </div>
                </div>
            </div>
            
            <!-- PKÊåëÊàò -->
            <div class="section" id="pkSection" style="display: none;">
                <div class="section-header">
                    ‚öîÔ∏è PKÊåëÊàò
                </div>
                <div class="section-content">
                    <div class="pk-card" id="pkCard">
                        <!-- PKÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
            
            <!-- ÊéíË°åÊ¶ú -->
            <div class="section">
                <div class="section-header">
                    üèÜ ÊéíË°åÊ¶ú
                </div>
                <div class="section-content" id="leaderboard">
                    <!-- ÊéíË°åÊ¶úÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            
            <!-- Â•ñÂä±Ê±† -->
            <div class="section">
                <div class="section-header">
                    üéÅ Â•ñÂä±Ê±†
                </div>
                <div class="section-content" id="rewardPool">
                    <!-- Â•ñÂä±ÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            
            <!-- ÂâßÊÉÖ -->
            <div class="section">
                <div class="section-header">
                    üìú ÂΩìÂâçÂâßÊÉÖ
                </div>
                <div class="section-content">
                    <div class="story-card" id="storyContent">
                        <div style="font-weight: bold; margin-bottom: 8px;">Á¨¨‰∏ÄÁ´†ÔºöÁ†¥Á¢éÁöÑÊó∂Èó¥Á∫ø</div>
                        <div style="font-size: 14px; line-height: 1.5;">
                            Âõ†ËøüÂà∞ÔºåÊó∂Èó¥ÊÄ™Áâ©Âêû‰∫Ü15ÂàÜÈíüÔºÅÂç∑Âç∑ÊâìÂ∑•ËøòÂÄ∫‰∏≠‚Ä¶<br>
                            ‚úÖÂÖ®ÈÉ®‰ªªÂä°ÂÆåÊàêÂèØËß£ÈîÅÂâßÊÉÖ„ÄêÊó∂Èó¥‰øÆÂ§çÊúØ„Äë
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Êìç‰ΩúÂè∞ -->
            <div class="section">
                <div class="section-header">
                    üéÆ Êìç‰ΩúÂè∞
                </div>
                <div class="section-content">
                    <div class="controls">
                        <button class="btn btn-primary" onclick="showTaskModal()">ÂÆåÊàê‰ªªÂä°</button>
                        <button class="btn btn-secondary" onclick="showPkModal()">PKÊåëÊàò</button>
                        <button class="btn btn-primary" onclick="drawCard()">ÊäΩÂç° (<span id="cardCount">0</span>Âà∏)</button>
                        <button class="btn btn-secondary" onclick="showInventory()">Êü•Áúã‰ªìÂ∫ì</button>
                        <button class="btn btn-primary" onclick="showAIHelper()">AIÂä©Êâã</button>
                        <button class="btn btn-secondary" onclick="showSettings()">ËÆæÁΩÆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                ÂÆåÊàê‰ªªÂä°
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>ËæìÂÖ•‰ªªÂä°ÁºñÂè∑ÔºàÂ¶ÇÔºöt1, t2Ôºâ</label>
                    <input type="text" id="taskInput" placeholder="t1">
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="completeTask()">ÂÆåÊàê</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                ËÆæÁΩÆ
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Ë±ÜÂåÖAPI Key</label>
                    <input type="password" id="apiKeyInput" placeholder="ËæìÂÖ•‰Ω†ÁöÑË±ÜÂåÖAPI Key">
                </div>
                <div class="input-group">
                    <label>Ë±ÜÂåÖÊé•ÂÖ•ÁÇπID</label>
                    <input type="text" id="endpointIdInput" placeholder="ep-20250921171945-t4wjq">
                    <small style="color: #6b7280; font-size: 12px;">
                        Âú®ÁÅ´Â±±ÊñπËàüÂàõÂª∫Êé®ÁêÜÊé•ÂÖ•ÁÇπÂêéËé∑ÂæóÁöÑIDÔºà‰Ω†ÁöÑIDÂ∑≤Ëá™Âä®Â°´ÂÖ•Ôºâ
                    </small>
                </div>
                <div class="input-group">
                    <label>ËÄÉÁ†îÊó•Êúü</label>
                    <input type="date" id="examDateInput" value="2025-12-20">
                </div>
                <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 12px;">
                    <strong>üìã Ë±ÜÂåÖAPIÈÖçÁΩÆÊåáÂçóÔºö</strong><br>
                    1. ËÆøÈóÆ console.volcengine.com/ark/<br>
                    2. ‰Ω†ÁöÑAPI Key: 0b511afb-2045-499c-a445-c6ed91f140ba<br>
                    3. ‰Ω†ÁöÑÊé•ÂÖ•ÁÇπID: ep-20250921171945-t4wjq<br>
                    4. ÁÇπÂáª"ÊµãËØïËøûÊé•"È™åËØÅÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ<br>
                    <strong>üéØ AIÂäüËÉΩÔºö</strong>ÊÄßÊ†ºÂåñÂØπËØù„ÄÅÂâßÊÉÖÁîüÊàê„ÄÅÂ≠¶‰π†Âª∫ËÆÆÈÉΩÁî±Ë±ÜÂåÖAIÂÆûÁé∞
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="saveSettings()">‰øùÂ≠ò</button>
                    <button class="btn btn-secondary" onclick="testAIConnection()">ÊµãËØïËøûÊé•</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                AIÂä©Êâã - Âç∑Âç∑
            </div>
            <div class="modal-body">
                <div id="aiChatHistory" style="height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        üê± Âç∑Âç∑ÔºöÊúâ‰ªÄ‰πàÂ≠¶‰π†ÈóÆÈ¢òÂèØ‰ª•ÈóÆÊàëÂì¶ÔºÅ
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="aiInput" placeholder="ÂêëÂç∑Âç∑ÊèêÈóÆ...">
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="sendToAI()">ÂèëÈÄÅ</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÈÄöÁü• -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Ê∏∏ÊàèÊï∞ÊçÆÁªìÊûÑ
        let gameData = {
            rank: { level: 'bronze', tier: 3, stars: 1 },
            ranking: 5555,
            todayPower: 0,
            totalExp: 0,
            cardCount: 0,
            catMood: 'hungry',
            tasks: [],
            completedTasks: [],
            inventory: [],
            availableRewards: [],
            virtualPlayers: [], // ËôöÊãüÁé©ÂÆ∂Êï∞ÊçÆ
            playerRelationships: {}, // ‰∏éËôöÊãüÁé©ÂÆ∂ÁöÑÂÖ≥Á≥ª
            settings: {
                apiKey: '',
                endpointId: '',
                examDate: '2025-12-20'
            },
            lastLoginDate: null,
            lastRewardCheck: null,
            lastTaskDate: null, // ‰∏äÊ¨°ÂÆåÊàê‰ªªÂä°ÁöÑÊó•Êúü
            pkChallenge: null,
            pkHistory: [], // PKÂéÜÂè≤ËÆ∞ÂΩï
            story: { 
                chapter: 1, 
                unlocked: ['chapter1'],
                currentScene: 'prologue',
                characterRelationships: {
                    'professor_chen': 0, // ÈôàÊïôÊéàÂ•ΩÊÑüÂ∫¶
                    'study_buddy_li': 0, // Â≠¶ÂèãÂ∞èÊùéÂ•ΩÊÑüÂ∫¶
                    'rival_wang': 0 // Á´û‰∫âÂØπÊâãÂ∞èÁéãÂ•ΩÊÑüÂ∫¶
                }
            },
            achievements: [], // ÊàêÂ∞±Á≥ªÁªü
            streakDays: 0, // ËøûÁª≠ÂÆåÊàê‰ªªÂä°Â§©Êï∞
            stats: {
                totalTasksCompleted: 0,
                pkWins: 0,
                pkLosses: 0,
                pkDraws: 0,
                rewardsEarned: 0
            }
        };
        
        // Êï∞ÊçÆÂ∫ìÊìç‰Ωú
        let db;
        
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ExamGameDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('gameData')) {
                        db.createObjectStore('gameData');
                    }
                };
            });
        }
        
        async function saveData() {
            const tx = db.transaction(['gameData'], 'readwrite');
            const store = tx.objectStore('gameData');
            await store.put(gameData, 'current');
            showNotification('Êï∞ÊçÆÂ∑≤‰øùÂ≠òÔºÅ');
        }
        
        async function loadData() {
            const tx = db.transaction(['gameData'], 'readonly');
            const store = tx.objectStore('gameData');
            const result = await store.get('current');
            if (result) {
                gameData = { ...gameData, ...result };
            }
        }
        
        // ÂàùÂßãÂåñÂ∫îÁî®ÔºàAIÂ¢ûÂº∫ÁâàÔºâ
        async function initApp() {
            await initDB();
            await loadData();
            
            // ËÆæÁΩÆÈªòËÆ§Êé•ÂÖ•ÁÇπID
            if (!gameData.settings.endpointId) {
                gameData.settings.endpointId = 'ep-20250921171945-t4wjq';
            }
            
            // ÂàùÂßãÂåñÂêÑÁßçÁ≥ªÁªü
            updateStoryDisplay();
            updateUI();
            updateCountdown();
            checkDailyReset();
            
            // ÂºÇÊ≠•ÂàùÂßãÂåñËôöÊãüÁé©ÂÆ∂ÔºàAIÁîüÊàêÔºâ
            initializeVirtualPlayers().then(() => {
                updateUI(); // ÈáçÊñ∞Êõ¥Êñ∞UI‰ª•ÊòæÁ§∫ÁîüÊàêÁöÑÁé©ÂÆ∂
            });
            
            // Âª∂ËøüËß¶ÂèëÈöèÊú∫‰∫ã‰ª∂ÔºåÈÅøÂÖçÂàùÂßãÂåñÊó∂Á´ãÂç≥ÂºπÁ™ó
            setTimeout(() => {
                generateRandomEvents();
            }, 5000);
            
            // ËÆæÁΩÆÂÆöÊó∂Âô®
            setInterval(updateCountdown, 1000);
            setInterval(updateScheduleDisplay, 30000); // ÊØè30ÁßíÊõ¥Êñ∞Êó∂Á®ãË°®
            setInterval(() => {
                if (Math.random() < 0.1) { // 10%Ê¶ÇÁéáËß¶ÂèëÈöèÊú∫‰∫ã‰ª∂
                    generateRandomEvents();
                }
            }, 300000); // ÊØè5ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°
            
            // ÊòæÁ§∫Ê¨¢Ëøé‰ø°ÊÅØ
            if (gameData.stats.totalTasksCompleted === 0) {
                setTimeout(showWelcomeMessage, 1000);
            } else {
                setTimeout(() => {
                    showNotification('ü§ñ AIÂ¢ûÂº∫Á≥ªÁªüÂ∑≤ÊøÄÊ¥ªÔºÅÂ•ñÂä±„ÄÅÂâßÊÉÖ„ÄÅÁé©ÂÆ∂ÈÉΩÁî±AIÂÆûÊó∂ÁîüÊàêÔºÅ');
                }, 1500);
            }
        }
        
        function showWelcomeMessage() {
            showNotification('üéÆ Ê¨¢ËøéÊù•Âà∞AIÈ©±Âä®ÁöÑÂç∑Âç∑ËÄÉÁ†îÂ§ß‰ΩúÊàòÔºÅÊãçÁÖß‰∏ä‰º†‰ªäÊó•‰ªªÂä°ÂºÄÂßãÊ∏∏ÊàèÂêßÔºÅ');
            setTimeout(() => {
                showNotification('ü§ñ Êú¨Ê∏∏ÊàèÁî±Ë±ÜÂåÖAIÊèê‰æõÊô∫ËÉΩÊîØÊåÅÔºåÊØèÊ¨°‰ΩìÈ™åÈÉΩÁã¨‰∏ÄÊó†‰∫åÔºÅ');
            }, 3000);
        }
        
        // Êõ¥Êñ∞ÁïåÈù¢
        function updateUI() {
            updateRankDisplay();
            updateTaskList();
            updateLeaderboard();
            updateRewardPool();
            updateCatStatus();
            updateScheduleDisplay();
            document.getElementById('cardCount').textContent = gameData.cardCount;
        }
        
        function updateCountdown() {
            const examDate = new Date('2025-12-20');
            const now = new Date();
            const diff = examDate - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            
            const today = now.toLocaleDateString('zh-CN', { 
                month: 'long', 
                day: 'numeric' 
            });
            
            let countdownText;
            if (days > 0) {
                countdownText = `${today} ¬∑ Ë∑ùÁ¶ª2025ËÄÉÁ†îËøòÊúâ${days}Â§©`;
            } else if (days === 0) {
                countdownText = `${today} ¬∑ ËÄÉÁ†îÂ∞±ÊòØ‰ªäÂ§©ÔºÅÂä†Ê≤πÔºÅ`;
            } else {
                countdownText = `${today} ¬∑ ËÄÉÁ†îÂ∑≤ÁªìÊùü${Math.abs(days)}Â§©`;
            }
            
            document.getElementById('countdown').textContent = countdownText;
        }
        
        function updateRankDisplay() {
            const ranks = {
                bronze: 'ÈùíÈìú', silver: 'ÁôΩÈì∂', gold: 'ÈªÑÈáë',
                platinum: 'ÈìÇÈáë', diamond: 'ÈíªÁü≥', 
                master: 'ÊòüËÄÄ', king: 'ÁéãËÄÖ'
            };
            
            const rankName = ranks[gameData.rank.level];
            const romanNumerals = ['', '‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§'];
            
            document.getElementById('rankBadge').textContent = 
                `${rankName}${romanNumerals[gameData.rank.tier]}`;
            
            document.getElementById('ranking').textContent = gameData.ranking;
            
            const stars = '‚òÖ'.repeat(gameData.rank.stars) + 
                         '‚òÜ'.repeat(5 - gameData.rank.stars);
            document.getElementById('starDisplay').textContent = stars;
            
            document.getElementById('todayPower').textContent = gameData.todayPower;
        }
        
        function updateCatStatus() {
            const moods = {
                happy: { emoji: 'üò∏', text: 'ÂºÄÂøÉÂú∞Èô™‰Ω†Â≠¶‰π†' },
                hungry: { emoji: 'üòæ', text: 'È•øËÇöÂ≠êÁ≠â‰Ω†ÊäïÂñÇ' },
                sleepy: { emoji: 'üò¥', text: 'Âõ∞Âõ∞ÊÉ≥Ë¶ÅÁù°ËßâËßâ' },
                excited: { emoji: 'ü§©', text: 'Ë∂ÖÂÖ¥Â•ãÊÉ≥Ë¶ÅÂÜ≤ÂÜ≤ÂÜ≤' },
                content: { emoji: 'üòä', text: 'Êª°Ë∂≥Âú∞ÁúãÁùÄ‰Ω†ËøõÊ≠•' },
                sad: { emoji: 'üòø', text: '‰∏∫‰Ω†ÁöÑÈÄÄÊ≠•ÊÑüÂà∞ÈöæËøá' },
                disappointed: { emoji: 'üòº', text: 'ÊúâÁÇπÂ§±Êúõ‰ΩÜËøòÊòØÊîØÊåÅ‰Ω†' }
            };
            
            const mood = moods[gameData.catMood] || moods.hungry;
            document.getElementById('catMood').textContent = mood.emoji;
            document.getElementById('catStatus').textContent = `Âç∑Âç∑ÂøÉÊÉÖÔºö${mood.text}`;
            
            // Ê†πÊçÆÂøÉÊÉÖË∞ÉÊï¥ÊòæÁ§∫ÊïàÊûú
            const catMoodElement = document.getElementById('catMood');
            catMoodElement.style.transform = gameData.catMood === 'excited' ? 'scale(1.2)' : 'scale(1)';
            catMoodElement.style.filter = gameData.catMood === 'sad' ? 'grayscale(50%)' : 'none';
        }
        
        function updateTaskList() {
            const container = document.getElementById('taskList');
            if (gameData.tasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        ÂæÖÊãçÁÖßÂΩïÂÖ•‰ªªÂä°
                    </div>
                `;
                return;
            }
            
            container.innerHTML = gameData.tasks.map((task, index) => `
                <div class="task-item ${gameData.completedTasks.includes(index) ? 'task-completed' : ''}">
                    <span>t${index + 1}. ${task}</span>
                    <span>${gameData.completedTasks.includes(index) ? '‚úÖ' : '‚è≥'}</span>
                </div>
            `).join('');
        }
        
        function generateVirtualPlayers() {
            // Á°Æ‰øùËôöÊãüÁé©ÂÆ∂Â∑≤ÂàùÂßãÂåñ
            if (gameData.virtualPlayers.length === 0) {
                initializeVirtualPlayers();
                return []; // ÂºÇÊ≠•ÂàùÂßãÂåñ‰∏≠ÔºåÂÖàËøîÂõûÁ©∫Êï∞ÁªÑ
            }
            
            updateVirtualPlayers();
            
            // Ê†πÊçÆÊÆµ‰ΩçÊéíÂ∫è
            const sortedPlayers = [...gameData.virtualPlayers].sort((a, b) => {
                const rankOrder = ['king', 'master', 'diamond', 'platinum', 'gold', 'silver', 'bronze'];
                const aRankIndex = rankOrder.indexOf(a.rankLevel);
                const bRankIndex = rankOrder.indexOf(b.rankLevel);
                
                if (aRankIndex !== bRankIndex) return aRankIndex - bRankIndex;
                if (a.tier !== b.tier) return a.tier - b.tier;
                return b.stars - a.stars;
            });
            
            // ÊèíÂÖ•Áî®Êà∑
            const userRanking = gameData.ranking;
            const ranks = { bronze: 'ÈùíÈìú', silver: 'ÁôΩÈì∂', gold: 'ÈªÑÈáë', platinum: 'ÈìÇÈáë', diamond: 'ÈíªÁü≥', master: 'ÊòüËÄÄ', king: 'ÁéãËÄÖ' };
            const romanNumerals = ['', '‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§'];
            
            const myPlayer = {
                name: '‰Ω†',
                rankLevel: gameData.rank.level,
                tier: gameData.rank.tier,
                stars: gameData.rank.stars,
                ranking: userRanking,
                displayRank: `${ranks[gameData.rank.level]}${romanNumerals[gameData.rank.tier]}`,
                displayStars: '‚òÖ'.repeat(gameData.rank.stars) + '‚òÜ'.repeat(5 - gameData.rank.stars)
            };
            
            // ‰∏∫ËôöÊãüÁé©ÂÆ∂Ê∑ªÂä†ÊòæÁ§∫‰ø°ÊÅØ
            sortedPlayers.forEach((player, index) => {
                player.ranking = index + 1;
                player.displayRank = `${ranks[player.rankLevel]}${romanNumerals[player.tier]}`;
                player.displayStars = '‚òÖ'.repeat(player.stars) + '‚òÜ'.repeat(5 - player.stars);
            });
            
            sortedPlayers.splice(userRanking - 1, 0, myPlayer);
            
            // ÊòæÁ§∫Ââç3Âêç + Áî®Êà∑ÈôÑËøëÁöÑÁé©ÂÆ∂
            const displayPlayers = [];
            
            // Ââç3Âêç
            displayPlayers.push(...sortedPlayers.slice(0, 3));
            
            if (userRanking > 6) {
                displayPlayers.push({ name: '...', displayRank: '', displayStars: '', ranking: '...' });
            }
            
            // Áî®Êà∑ÈôÑËøëÁöÑÁé©ÂÆ∂
            const start = Math.max(0, userRanking - 2);
            const end = Math.min(sortedPlayers.length, userRanking + 2);
            
            if (userRanking > 3) {
                displayPlayers.push(...sortedPlayers.slice(start, end));
            }
            
            return displayPlayers;
        }
        
        function updateLeaderboard() {
            const players = generateVirtualPlayers();
            const container = document.getElementById('leaderboard');
            
            if (players.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        ü§ñ Ê≠£Âú®ÁîüÊàêËôöÊãüÁé©ÂÆ∂...
                    </div>
                `;
                return;
            }
            
            container.innerHTML = players.map((player) => {
                const isMyRank = player.name === '‰Ω†';
                const isDivider = player.name === '...';
                
                if (isDivider) {
                    return `
                        <div class="leaderboard-item" style="text-align: center; color: #6b7280;">
                            <span>...</span>
                        </div>
                    `;
                }
                
                // Ê∑ªÂä†ËøõÊ≠•/ÈÄÄÊ≠•ÊåáÁ§∫Âô®ÂíåAIÊ†áËØÜ
                let trendIcon = '';
                let aiIcon = '';
                
                if (player.momentum !== undefined) {
                    if (player.momentum > 0.3) trendIcon = 'üìà';
                    else if (player.momentum < -0.3) trendIcon = 'üìâ';
                    else trendIcon = '‚û°Ô∏è';
                }
                
                if (player.aiGenerated) {
                    aiIcon = 'ü§ñ';
                }
                
                return `
                    <div class="leaderboard-item ${isMyRank ? 'my-rank' : ''}">
                        <span class="player-rank">${player.ranking}. ${player.name} ${trendIcon}${aiIcon}</span>
                        <span>${player.displayRank} ${player.displayStars}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ÊòæÁ§∫‰ªìÂ∫ìÔºàÊîØÊåÅAIÁîüÊàêÊ†áËØÜÔºâ
        function showInventory() {
            let inventoryHTML = gameData.inventory.length === 0 
                ? '‰ªìÂ∫ìÁ©∫Á©∫Â¶Ç‰πü...' 
                : gameData.inventory.map((item, index) => {
                    const aiIcon = item.aiGenerated ? ' ü§ñ' : '';
                    const generateButton = (item.type === 'costume' && item.costume) ? 
                        `<button class="btn btn-primary" style="padding: 2px 6px; font-size: 10px;" onclick="generateFromInventory(${index})">ÁîüÊàêÂõæÁâá</button>` : '';
                    
                    return `
                        <div style="padding: 8px; margin: 4px 0; background: #f8fafc; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div>${item.name}${aiIcon}</div>
                                ${item.description ? `<div style="font-size: 10px; color: #6b7280;">${item.description}</div>` : ''}
                            </div>
                            ${generateButton}
                        </div>
                    `;
                }).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        üì¶ ÊàëÁöÑ‰ªìÂ∫ì
                        <div style="font-size: 11px; opacity: 0.8;">ü§ñ = AIÁîüÊàêÁâ©ÂìÅ</div>
                    </div>
                    <div class="modal-body">
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${inventoryHTML}
                        </div>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // AIÁîüÊàêËôöÊãüÁé©ÂÆ∂Á≥ªÁªü
        async function generateAIPlayer() {
            const prompt = `ÁîüÊàê‰∏Ä‰∏™ËÄÉÁ†îÊ∏∏Êàè‰∏≠ÁöÑËôöÊãüÁé©ÂÆ∂ÔºåË¶ÅÊ±ÇÔºö

Ë¶ÅÊ±ÇÔºö
1. ÂßìÂêçÔºöÊúâÂàõÊÑèÁöÑËÄÉÁ†îÁõ∏ÂÖ≥ÊòµÁß∞Ôºå‰∏çË¶ÅÈáçÂ§çÂ∏∏ËßÅÁöÑ
2. ÊÄßÊ†ºÔºö‰ªéËøô‰∫õ‰∏≠ÈÄâ‰∏Ä‰∏™ - confident,shy,aggressive,supportive,silent,sarcastic,cheerful,competitive
3. ‰∏ì‰∏öÔºöÊï∞Â≠¶„ÄÅËã±ËØ≠„ÄÅÊîøÊ≤ª„ÄÅËÆ°ÁÆóÊú∫„ÄÅÁªºÂêàÁ≠â
4. ÊÆµ‰ΩçÔºöbronze,silver,gold,platinum,diamond,master,king
5. ÊòüÁ∫ßÔºö1-5
6. ËÉåÊôØÊïÖ‰∫ãÔºö‰∏ÄÂè•ËØùÁöÑÁÆÄÁü≠ËÉåÊôØ

ÂõûÂ§çÊ†ºÂºèÔºöÂßìÂêç|ÊÄßÊ†º|‰∏ì‰∏ö|ÊÆµ‰Ωç|ÊòüÁ∫ß|ËÉåÊôØÊïÖ‰∫ã
Á§∫‰æãÔºöÂ§úÁ©∫ÂÆàÊúõËÄÖ|shy|Êï∞Â≠¶|gold|3|Êù•Ëá™Â∞èÂüéÂ∏ÇÁöÑÊï∞Â≠¶Â§©ÊâçÔºåÊ¢¶ÊÉ≥ËÄÉÂÖ•985

‰∏ÄË°åÂõûÂ§çÔºå‰∏çË¶ÅÂ§ö‰ΩôÂÜÖÂÆπ`;

            try {
                const response = await callDoubaoAPI(prompt);
                const parts = response.split('|');
                
                if (parts.length >= 6) {
                    return {
                        name: parts[0].trim(),
                        personality: parts[1].trim(),
                        subject: parts[2].trim(),
                        rankLevel: parts[3].trim(),
                        stars: parseInt(parts[4].trim()) || Math.floor(Math.random() * 5) + 1,
                        tier: Math.floor(Math.random() * 5) + 1,
                        background: parts[5].trim(),
                        lastActive: new Date().toISOString(),
                        momentum: Math.random() * 2 - 1,
                        relationshipWithUser: Math.random() * 2 - 1,
                        aiGenerated: true
                    };
                } else {
                    throw new Error('AIÂõûÂ§çÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('AIÁé©ÂÆ∂ÁîüÊàêÂ§±Ë¥•:', error);
                return generateFallbackPlayer();
            }
        }
        
        function generateFallbackPlayer() {
            const names = ['Â≠¶‰π†Ëææ‰∫∫', 'Âà∑È¢òÊú∫Âô®', 'ËÄÉÁ†îÊàòÂ£´', 'Áü•ËØÜÊé¢Á¥¢ËÄÖ', 'Â≠¶Èú∏‰πãË∑Ø'];
            const personalities = ['confident', 'shy', 'aggressive', 'supportive', 'competitive'];
            const subjects = ['Êï∞Â≠¶', 'Ëã±ËØ≠', 'ÊîøÊ≤ª', 'ËÆ°ÁÆóÊú∫', 'ÁªºÂêà'];
            const levels = ['bronze', 'silver', 'gold', 'platinum', 'diamond'];
            
            return {
                name: names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 999),
                personality: personalities[Math.floor(Math.random() * personalities.length)],
                subject: subjects[Math.floor(Math.random() * subjects.length)],
                rankLevel: levels[Math.floor(Math.random() * levels.length)],
                tier: Math.floor(Math.random() * 5) + 1,
                stars: Math.floor(Math.random() * 5) + 1,
                background: 'Á•ûÁßòÁöÑËÄÉÁ†îÁé©ÂÆ∂',
                lastActive: new Date().toISOString(),
                momentum: Math.random() * 2 - 1,
                relationshipWithUser: Math.random() * 2 - 1,
                aiGenerated: false
            };
        }
        
        // AIÁîüÊàêÂâßÊÉÖ‰∫ã‰ª∂
        async function generateAIStoryEvent() {
            const prompt = `‰Ω†ÊòØËÄÉÁ†îÊ∏∏ÊàèÁöÑÂâßÊÉÖÁîüÊàêÁ≥ªÁªü„ÄÇÂü∫‰∫éÁî®Êà∑ÂΩìÂâçÁä∂ÂÜµÁîüÊàê‰∏Ä‰∏™ÂâßÊÉÖ‰∫ã‰ª∂Ôºö

Áî®Êà∑ÂΩìÂâçÁä∂ÂÜµÔºö
- Á¥ØËÆ°ÂÆåÊàê‰ªªÂä°Ôºö${gameData.stats.totalTasksCompleted}‰∏™
- ËøûÁª≠Â≠¶‰π†Ôºö${gameData.streakDays}Â§©
- ÂΩìÂâçÊÆµ‰ΩçÔºö${gameData.rank.level} ${gameData.rank.tier}ÊÆµ ${gameData.rank.stars}Êòü
- PKÊàòÁª©Ôºö${gameData.stats.pkWins}ËÉú${gameData.stats.pkLosses}Ë¥ü
- ÂΩìÂâçÊó∂Èó¥Ôºö${new Date().getHours()}:${new Date().getMinutes()}

ÁîüÊàêË¶ÅÊ±ÇÔºö
1. ‰∫ã‰ª∂Ê†áÈ¢òÔºöÁÆÄÁü≠ÊúâË∂£ÁöÑÊ†áÈ¢ò
2. ‰∫ã‰ª∂ÂÜÖÂÆπÔºö100Â≠ó‰ª•ÂÜÖÁöÑÂâßÊÉÖÊèèËø∞ÔºåË¶ÅÁªìÂêàÁî®Êà∑Áä∂ÂÜµ
3. ÈÄâÊã©1ÔºöÁ¨¨‰∏Ä‰∏™Ë°åÂä®ÈÄâÊã©ÂèäÁÆÄÁü≠ÊïàÊûúÊèèËø∞
4. ÈÄâÊã©2ÔºöÁ¨¨‰∫å‰∏™Ë°åÂä®ÈÄâÊã©ÂèäÁÆÄÁü≠ÊïàÊûúÊèèËø∞

ÂõûÂ§çÊ†ºÂºèÔºö
Ê†áÈ¢ò|ÂÜÖÂÆπ|ÈÄâÊã©1|ÊïàÊûú1|ÈÄâÊã©2|ÊïàÊûú2

Á§∫‰æãÔºö
Âõæ‰π¶È¶ÜÁöÑÁ•ûÁßòÁ∫∏Êù°|‰Ω†Âú®Âõæ‰π¶È¶ÜÂ∫ß‰Ωç‰∏äÂèëÁé∞‰∫Ü‰∏ÄÂº†Á•ûÁßòÁ∫∏Êù°Ôºå‰∏äÈù¢ÂÜôÁùÄÂ≠¶‰π†ÊäÄÂ∑ßÂíåÈºìÂä±ÁöÑËØù|‰ªîÁªÜÁ†îÁ©∂Á∫∏Êù°|Ëé∑ÂæóÂ≠¶‰π†Âä†ÈÄüÂç°|ÂØªÊâæÁ∫∏Êù°‰∏ª‰∫∫|ÂèØËÉΩÈÅáÂà∞Â≠¶‰π†‰ºô‰º¥

Ë¶ÅÊ±ÇÔºö
- ÂâßÊÉÖË¶ÅÊúâË∂£„ÄÅË¥¥ÂêàËÄÉÁ†î‰∏ªÈ¢ò
- ÈÄâÊã©Ë¶ÅÊúâÊòéÊòæÂå∫Âà´ÂíåÂêéÊûú
- ‰∏ÄË°åÂõûÂ§çÔºå‰∏çË¶ÅÂ§ö‰ΩôÂÜÖÂÆπ`;

            try {
                const response = await callDoubaoAPI(prompt);
                const parts = response.split('|');
                
                if (parts.length >= 6) {
                    return {
                        id: 'ai_event_' + Date.now(),
                        title: parts[0].trim(),
                        content: parts[1].trim(),
                        choices: [
                            {
                                text: parts[2].trim(),
                                effect: () => applyStoryEffect(parts[3].trim())
                            },
                            {
                                text: parts[4].trim(),
                                effect: () => applyStoryEffect(parts[5].trim())
                            }
                        ],
                        aiGenerated: true
                    };
                } else {
                    throw new Error('AIÂõûÂ§çÊ†ºÂºèÈîôËØØ');
                }
            } catch (error) {
                console.error('AIÂâßÊÉÖÁîüÊàêÂ§±Ë¥•:', error);
                return generateFallbackStoryEvent();
            }
        }
        
        function generateFallbackStoryEvent() {
            const events = [
                {
                    id: 'fallback_event',
                    title: 'Â≠¶‰π†Â∞èÊèíÊõ≤',
                    content: 'Âú®Â≠¶‰π†ËøáÁ®ã‰∏≠ÈÅáÂà∞‰∫Ü‰∏Ä‰∏™Â∞èÊÉÖÂÜµ...',
                    choices: [
                        { text: 'ÁªßÁª≠Â≠¶‰π†', effect: () => applyStoryEffect('Ëé∑Âæó‰∏ìÊ≥®Âä†Êàê') },
                        { text: 'Á®ç‰Ωú‰ºëÊÅØ', effect: () => applyStoryEffect('ÊÅ¢Â§çÁ≤æÁ•ûÁä∂ÊÄÅ') }
                    ],
                    aiGenerated: false
                }
            ];
            
            return events[0];
        }
        
        function applyStoryEffect(effectDescription) {
            // Ê†πÊçÆÊïàÊûúÊèèËø∞Â∫îÁî®Ê∏∏ÊàèÊïàÊûú
            if (effectDescription.includes('Âä†ÈÄüÂç°') || effectDescription.includes('‰∏ìÊ≥®')) {
                gameData.inventory.push({ type: 'virtual', name: 'Â≠¶‰π†Âä†ÈÄüÂç°√ó1' });
                showNotification(`üìö ${effectDescription}ÔºÅËé∑ÂæóÂ≠¶‰π†Âä†ÈÄüÂç°ÔºÅ`);
            } else if (effectDescription.includes('ÁªèÈ™å') || effectDescription.includes('ÊàòÂäõ')) {
                gameData.todayPower += 15;
                showNotification(`‚ö° ${effectDescription}ÔºÅ+15ÊàòÂäõÔºÅ`);
            } else if (effectDescription.includes('Ë£ÖÊâÆ') || effectDescription.includes('Â•ñÂä±')) {
                gameData.cardCount += 1;
                showNotification(`üéÅ ${effectDescription}ÔºÅËé∑ÂæóÊäΩÂç°Âà∏√ó1ÔºÅ`);
            } else if (effectDescription.includes('Â≠¶‰π†‰ºô‰º¥') || effectDescription.includes('ÊúãÂèã')) {
                // Âä†ÂÖ•Êñ∞ÁöÑAIÁîüÊàêËôöÊãüÁé©ÂÆ∂
                generateAIPlayer().then(newPlayer => {
                    gameData.virtualPlayers.push(newPlayer);
                    showNotification(`üë• ${effectDescription}ÔºÅÈÅáÂà∞‰∫ÜÊñ∞ÊúãÂèãÔºö${newPlayer.name}ÔºÅ`);
                });
            } else {
                // ÈªòËÆ§ÊïàÊûú
                gameData.todayPower += 10;
                showNotification(`‚ú® ${effectDescription}ÔºÅ`);
            }
        }
        
        // Êô∫ËÉΩËôöÊãüÁé©ÂÆ∂ÂàùÂßãÂåñÁ≥ªÁªü
        async function initializeVirtualPlayers() {
            if (gameData.virtualPlayers.length === 0) {
                showNotification('ü§ñ Ê≠£Âú®ÁîüÊàêËôöÊãüÁé©ÂÆ∂...');
                
                // ÁîüÊàê‰∏Ä‰∫õÂü∫Á°ÄÁé©ÂÆ∂
                const basicPlayers = [
                    { name: 'ÂåóÂ§ßÁãôÁ•û', personality: 'confident', subject: 'math', rankLevel: 'king', tier: 5, stars: 4, background: 'ÂåóÂ§ßÊï∞Â≠¶Á≥ªÂ≠¶Èú∏', aiGenerated: false },
                    { name: 'Ê∏ÖÂçéÂ≠¶Èú∏', personality: 'competitive', subject: 'cs', rankLevel: 'king', tier: 4, stars: 3, background: 'Ê∏ÖÂçéËÆ°ÁÆóÊú∫Á≥ªÈ´òÊâã', aiGenerated: false },
                    { name: 'Â§çÊó¶ÊñáË±™', personality: 'shy', subject: 'politics', rankLevel: 'master', tier: 5, stars: 2, background: 'Â§çÊó¶ÊîøÊ≤ªÂ≠¶‰∏ì‰∏ö', aiGenerated: false }
                ];
                
                gameData.virtualPlayers = [...basicPlayers];
                
                // AIÁîüÊàêÊõ¥Â§öÁé©ÂÆ∂
                const generatePromises = [];
                for (let i = 0; i < 15; i++) { // ÂÖàÁîüÊàê15‰∏™AIÁé©ÂÆ∂
                    generatePromises.push(generateAIPlayer());
                }
                
                try {
                    const aiPlayers = await Promise.all(generatePromises);
                    gameData.virtualPlayers.push(...aiPlayers);
                    
                    // Â°´ÂÖÖÂâ©‰ΩôÁöÑÈöèÊú∫Áé©ÂÆ∂Âà∞100‰∏™
                    while (gameData.virtualPlayers.length < 100) {
                        gameData.virtualPlayers.push(generateFallbackPlayer());
                    }
                    
                    showNotification('‚úÖ ËôöÊãüÁé©ÂÆ∂ÁîüÊàêÂÆåÊàêÔºÅÂåÖÂê´AIÁîüÊàêÁé©ÂÆ∂');
                } catch (error) {
                    console.error('AIÁé©ÂÆ∂ÁîüÊàêÈÉ®ÂàÜÂ§±Ë¥•:', error);
                    // Â°´ÂÖÖÂà∞100‰∏™
                    while (gameData.virtualPlayers.length < 100) {
                        gameData.virtualPlayers.push(generateFallbackPlayer());
                    }
                    showNotification('‚ö†Ô∏è ËôöÊãüÁé©ÂÆ∂ÁîüÊàêÂÆåÊàêÔºàÈÉ®ÂàÜAIÁîüÊàêÂ§±Ë¥•Ôºâ');
                }
                
                // ÊØè‰∏™Áé©ÂÆ∂Ê∑ªÂä†Âä®ÊÄÅÂ±ûÊÄß
                gameData.virtualPlayers.forEach(player => {
                    if (!player.lastActive) player.lastActive = new Date().toISOString();
                    if (player.momentum === undefined) player.momentum = Math.random() * 2 - 1;
                    if (player.relationshipWithUser === undefined) player.relationshipWithUser = Math.random() * 2 - 1;
                });
            }
        }
        
        // AIÈöèÊú∫‰∫ã‰ª∂ÁîüÊàê
        async function generateRandomEvents() {
            // ÈöèÊú∫PK‰∫ã‰ª∂ÔºàÊØè5ÂàÜÈíü20%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.2) {
                await generatePKChallenge();
            }
            
            // AIÂâßÊÉÖ‰∫ã‰ª∂ÔºàÊØè10ÂàÜÈíü15%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.15) {
                await triggerAIStoryEvent();
            }
            
            // ËôöÊãüÁé©ÂÆ∂Âä®ÊÄÅÊõ¥Êñ∞
            updateVirtualPlayers();
            
            // ÈöèÊú∫ÁîüÊàêÊñ∞Áé©ÂÆ∂ÔºàÊØèÂ∞èÊó∂5%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.05 && gameData.virtualPlayers.length < 120) {
                try {
                    const newPlayer = await generateAIPlayer();
                    gameData.virtualPlayers.push(newPlayer);
                    showNotification(`üë• Êñ∞Áé©ÂÆ∂Âä†ÂÖ•Ôºö${newPlayer.name} (${newPlayer.background})`);
                } catch (error) {
                    console.error('Êñ∞Áé©ÂÆ∂ÁîüÊàêÂ§±Ë¥•:', error);
                }
            }
        }
        
        async function triggerAIStoryEvent() {
            try {
                const event = await generateAIStoryEvent();
                showChoiceModal(event);
                
                const aiTag = event.aiGenerated ? ' ü§ñAIÁîüÊàê' : '';
                showNotification(`üé≠ ÂâßÊÉÖ‰∫ã‰ª∂Ôºö${event.title}${aiTag}`);
            } catch (error) {
                console.error('AIÂâßÊÉÖ‰∫ã‰ª∂ÁîüÊàêÂ§±Ë¥•:', error);
                // ÈôçÁ∫ßÂà∞‰º†ÁªüÂâßÊÉÖ‰∫ã‰ª∂
                triggerMinorStoryEvent();
            }
        }
        
        // ËôöÊãüÁé©ÂÆ∂Âä®ÊÄÅÊõ¥Êñ∞Á≥ªÁªü
        function updateVirtualPlayers() {
            const now = new Date();
            
            gameData.virtualPlayers.forEach(player => {
                const lastActive = new Date(player.lastActive);
                const daysSinceActive = (now - lastActive) / (1000 * 60 * 60 * 24);
                
                // ÊØèÂ§©Êúâ30%Ê¶ÇÁéáÊõ¥Êñ∞Áé©ÂÆ∂Áä∂ÊÄÅ
                if (daysSinceActive >= 1 && Math.random() < 0.3) {
                    // Ê†πÊçÆmomentumË∞ÉÊï¥ÊÆµ‰Ωç
                    if (player.momentum > 0.3 && Math.random() < 0.4) {
                        // ËøõÊ≠•
                        if (player.stars < 5) {
                            player.stars++;
                        } else {
                            player.stars = 1;
                            if (player.tier > 1) {
                                player.tier--;
                            } else {
                                const rankOrder = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'master', 'king'];
                                const currentIndex = rankOrder.indexOf(player.rankLevel);
                                if (currentIndex < rankOrder.length - 1) {
                                    player.rankLevel = rankOrder[currentIndex + 1];
                                    player.tier = 5;
                                }
                            }
                        }
                    } else if (player.momentum < -0.3 && Math.random() < 0.2) {
                        // ÈÄÄÊ≠•
                        if (player.stars > 1) {
                            player.stars--;
                        } else {
                            player.stars = 5;
                            if (player.tier < 5) {
                                player.tier++;
                            } else {
                                const rankOrder = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'master', 'king'];
                                const currentIndex = rankOrder.indexOf(player.rankLevel);
                                if (currentIndex > 0) {
                                    player.rankLevel = rankOrder[currentIndex - 1];
                                    player.tier = 1;
                                }
                            }
                        }
                    }
                    
                    // Êõ¥Êñ∞momentum
                    player.momentum += (Math.random() - 0.5) * 0.4;
                    player.momentum = Math.max(-1, Math.min(1, player.momentum));
                    
                    player.lastActive = now.toISOString();
                }
            });
        }
        
        // ÈöèÊú∫Â•ñÂä±Á≥ªÁªüÔºàÂçáÁ∫ß‰∏∫AIÁîüÊàêÔºâ
        async function giveRandomReward() {
            try {
                const reward = await generateAIReward('ÈöèÊú∫Âç≥Êó∂Â•ñÂä±');
                
                if (reward.type === 'Ë£ÖÊâÆ' || reward.type === 'costume') {
                    gameData.inventory.push({
                        type: 'costume',
                        name: reward.name,
                        costume: reward.description,
                        aiGenerated: reward.aiGenerated
                    });
                } else if (reward.type === 'ÈÅìÂÖ∑' || reward.type === 'virtual') {
                    if (reward.name.includes('ÊäΩÂç°Âà∏')) {
                        const amount = parseInt(reward.name.match(/\d+/)?.[0]) || 1;
                        gameData.cardCount += amount;
                    }
                    gameData.inventory.push({
                        type: 'virtual',
                        name: reward.name,
                        aiGenerated: reward.aiGenerated
                    });
                } else {
                    gameData.inventory.push(reward);
                }
                
                const aiTag = reward.aiGenerated ? ' ü§ñ' : '';
                showNotification(`üéÅ ÈöèÊú∫Â•ñÂä±Ôºö${reward.name}ÔºÅ${aiTag}`);
            } catch (error) {
                console.error('AIÈöèÊú∫Â•ñÂä±ÁîüÊàêÂ§±Ë¥•:', error);
                // ÈôçÁ∫ßÂà∞ÁÆÄÂçïÂ•ñÂä±
                gameData.cardCount += 1;
                showNotification(`üéÅ ÈöèÊú∫Â•ñÂä±ÔºöÊäΩÂç°Âà∏√ó1ÔºÅ`);
            }
        }
        
        // ÊäΩÂç°Á≥ªÁªüÔºàAIÂ¢ûÂº∫Ôºâ
        async function drawCard() {
            if (gameData.cardCount <= 0) {
                showNotification('ÊäΩÂç°Âà∏‰∏çË∂≥ÔºÅ', 'error');
                return;
            }
            
            gameData.cardCount--;
            
            try {
                const reward = await generateAIReward('ÊäΩÂç°Ëé∑Âæó');
                
                if (reward.type === 'Ë£ÖÊâÆ' || reward.type === 'costume') {
                    gameData.inventory.push({
                        type: 'costume',
                        name: reward.name,
                        costume: reward.description,
                        aiGenerated: reward.aiGenerated
                    });
                } else {
                    gameData.inventory.push(reward);
                }
                
                const aiTag = reward.aiGenerated ? ' ü§ñAIÁîüÊàê' : '';
                showNotification(`üé¥ ÊäΩÂç°Ëé∑ÂæóÔºö${reward.name}ÔºÅ${aiTag}`);
                
                // ËØ¢ÈóÆÊòØÂê¶ÁîüÊàêË£ÖÊâÆÂõæÁâá
                if ((reward.type === 'Ë£ÖÊâÆ' || reward.type === 'costume') && reward.description) {
                    const shouldGenerate = confirm(`üé® ÊòØÂê¶ÁîüÊàêÂç∑Âç∑Á©øÁùÄ„Äê${reward.name}„ÄëÁöÑÂõæÁâáÔºü`);
                    if (shouldGenerate) {
                        generateCatImage(reward.description);
                    }
                }
            } catch (error) {
                console.error('AIÊäΩÂç°Â•ñÂä±ÁîüÊàêÂ§±Ë¥•:', error);
                // ÈôçÁ∫ßÂ•ñÂä±
                gameData.inventory.push({
                    type: 'virtual',
                    name: 'Á•ûÁßòÁ§ºÂåÖ√ó1',
                    aiGenerated: false
                });
                showNotification(`üé¥ ÊäΩÂç°Ëé∑ÂæóÔºöÁ•ûÁßòÁ§ºÂåÖ√ó1ÔºÅ`);
            }
            
            updateUI();
            saveData();
        }
        
        function updateRewardPool() {
            const rewards = [
                '‚ñ∏Âç∑Âç∑„ÄêÂ•∂ÂíñÂ∞èÊØõË°£„ÄëË£ÖÊâÆ',
                '‚ñ∏Ëå∂ÁôæÈÅì¬∑ËåâËéâÂ•∂Áªø+ËäãÊ≥•Ê≥¢Ê≥¢(ÂéªÂÜ∞)',
                '‚ñ∏ÊäΩÂç°Âà∏√ó1',
                '‚ñ∏Áõ≤ÁõíÔºöÂ∞èÂ∞èÂèõÊ°É(ÈöèÊú∫Ê¨æ)'
            ];
            
            const container = document.getElementById('rewardPool');
            container.innerHTML = rewards.map(reward => `
                <div class="reward-item">
                    <span>${reward}</span>
                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" 
                            onclick="claimReward('${reward}')">È¢ÜÂèñ</button>
                </div>
            `).join('');
        }
        
        // ‰ªªÂä°Áõ∏ÂÖ≥ÂäüËÉΩ
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }
        
        async function handleFileUpload(file) {
            showNotification('Ê≠£Âú®ËØÜÂà´‰ªªÂä°Ê∏ÖÂçï...ËØ∑Á®çÁ≠â');
            
            // ÊòæÁ§∫‰∏ä‰º†ÁöÑÂõæÁâáÈ¢ÑËßà
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 200px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    padding: 10px;
                `;
                preview.innerHTML = `
                    <div style="font-size: 12px; margin-bottom: 5px;">üì∑ ‰ªªÂä°Ê∏ÖÂçï</div>
                    <img src="${e.target.result}" style="width: 100%; border-radius: 4px;">
                    <div style="font-size: 10px; color: #6b7280; margin-top: 5px;">Ê≠£Âú®ËØÜÂà´‰∏≠...</div>
                `;
                document.body.appendChild(preview);
                
                setTimeout(() => {
                    if (document.body.contains(preview)) {
                        document.body.removeChild(preview);
                    }
                }, 5000);
            };
            reader.readAsDataURL(file);
            
            try {
                // Ê®°ÊãüAIËØÜÂà´ËøáÁ®ãÔºà2-4ÁßíÈöèÊú∫Âª∂ËøüÔºâ
                const delay = 2000 + Math.random() * 2000;
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // Êô∫ËÉΩÁîüÊàê‰ªªÂä°ÂàóË°®ÔºàÊõ¥ÁúüÂÆûÁöÑÊ®°ÊãüÔºâ
                const taskTemplates = [
                    // Êï∞Â≠¶Á±ª
                    ['ÂÆåÊàêÁ∫øÊÄß‰ª£Êï∞‰π†È¢òÁ¨¨3Á´†1-10È¢ò', 'Â§ç‰π†Ê¶ÇÁéáËÆ∫Áü•ËØÜÁÇπÔºöË¥ùÂè∂ÊñØÂÆöÁêÜ', 'Âà∑È´òÁ≠âÊï∞Â≠¶ÁúüÈ¢ò2Â•ó'],
                    ['ÂÆåÊàêÊï∞Â≠¶ÂàÜÊûêÁªÉ‰π†È¢ò20ÈÅì', 'Êï¥ÁêÜÂæÆÁßØÂàÜÂÖ¨ÂºèÁ¨îËÆ∞', 'ÂÅöÂéÜÂπ¥ÁúüÈ¢òÊï∞Â≠¶ÈÉ®ÂàÜ'],
                    
                    // Ëã±ËØ≠Á±ª
                    ['ËÉåËØµËÄÉÁ†îËØçÊ±áDay15Ôºà150‰∏™Ôºâ', 'ÂÆåÊàêËã±ËØ≠ÈòÖËØªÁêÜËß£4ÁØá', 'ÂÜô‰ΩúÊñá1ÁØáÔºöÁéØÂ¢É‰øùÊä§ËØùÈ¢ò'],
                    ['ÁøªËØëÁªÉ‰π†2ÁØá', 'ËÉåËØµËã±ËØ≠‰ΩúÊñáÊ®°Êùø', 'Âê¨ÂäõÁªÉ‰π†30ÂàÜÈíü'],
                    
                    // ‰∏ì‰∏öËØæÁ±ª
                    ['Â§ç‰π†ËÆ°ÁÆóÊú∫ÁΩëÁªúÁ¨¨4Á´†', 'Êï¥ÁêÜÊï∞ÊçÆÁªìÊûÑÊ†ëÁöÑÁü•ËØÜÁÇπ', 'ÁºñÁ®ãÁªÉ‰π†Ôºö‰∫åÂèâÊ†ëÈÅçÂéÜ'],
                    ['ÁúãÊìç‰ΩúÁ≥ªÁªüËßÜÈ¢ëËØæÁ®ã2Â∞èÊó∂', 'ÂÅöËÆ°ÁÆóÊú∫ÁªÑÊàêÂéüÁêÜÈ¢òÁõÆ', 'Â§ç‰π†Êï∞ÊçÆÂ∫ìËÆæËÆ°ËåÉÂºè'],
                    
                    // ÊîøÊ≤ªÁ±ª
                    ['ËÉåËØµÈ©¨ÂéüÈáçÁÇπÊ¶ÇÂøµ20‰∏™', 'ÂÅöÊîøÊ≤ªÈÄâÊã©È¢ò100ÈÅì', 'Êï¥ÁêÜËøë‰ª£Âè≤Êó∂Èó¥ËΩ¥'],
                    ['Â§ç‰π†ÊØõÊ¶ÇÁü•ËØÜÁÇπÔºöÁßëÂ≠¶ÂèëÂ±ïËßÇ', 'ËÉåËØµÊîøÊ≤ªÂ§ßÈ¢òÁ≠îÈ¢òÊ®°Êùø', 'ÂÅöÊó∂ÊîøÈ¢òÁõÆ50ÈÅì'],
                    
                    // ÁªºÂêàÁ±ª
                    ['Âà∂ÂÆöÊòéÊó•Â≠¶‰π†ËÆ°Âàí', 'Êï¥ÁêÜÈîôÈ¢òÊú¨', 'Â§ç‰π†‰ªäÊó•ÊâÄÂ≠¶ÂÜÖÂÆπ', 'È¢Ñ‰π†ÊòéÂ§©ÁöÑËØæÁ®ãÂÜÖÂÆπ']
                ];
                
                // ÈöèÊú∫ÈÄâÊã©‰ªªÂä°ÁªÑÂêà
                const selectedTemplate = taskTemplates[Math.floor(Math.random() * taskTemplates.length)];
                const additionalTasks = taskTemplates[Math.floor(Math.random() * taskTemplates.length)];
                
                // ÁªÑÂêà‰ªªÂä°ÔºåÁ°Æ‰øùÊúâ4-7‰∏™‰ªªÂä°
                let allTasks = [...selectedTemplate];
                
                // ÈöèÊú∫Ê∑ªÂä†1-3‰∏™ÂÖ∂‰ªñ‰ªªÂä°
                const extraCount = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < extraCount; i++) {
                    const randomTask = additionalTasks[Math.floor(Math.random() * additionalTasks.length)];
                    if (!allTasks.includes(randomTask)) {
                        allTasks.push(randomTask);
                    }
                }
                
                // ÈöèÊú∫Êâì‰π±È°∫Â∫è
                allTasks = allTasks.sort(() => Math.random() - 0.5);
                
                gameData.tasks = allTasks;
                gameData.completedTasks = [];
                gameData.lastTaskDate = new Date().toDateString();
                
                updateTaskList();
                saveData();
                showNotification(`‚úÖ ‰ªªÂä°ËØÜÂà´ÂÆåÊàêÔºÅÂÖ±ËØÜÂà´Âà∞${allTasks.length}‰∏™‰ªªÂä°`);
                
                // Ëß¶ÂèëÂâßÊÉÖ‰∫ã‰ª∂
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        triggerMinorStoryEvent();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‰ªªÂä°ËØÜÂà´Â§±Ë¥•:', error);
                showNotification('‚ùå ‰ªªÂä°ËØÜÂà´Â§±Ë¥•ÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†', 'error');
            }
        }
        
        function completeTask() {
            const input = document.getElementById('taskInput').value.trim().toLowerCase();
            const match = input.match(/^t(\d+)$/);
            
            if (!match) {
                showNotification('Ê†ºÂºèÈîôËØØÔºÅËØ∑ËæìÂÖ•t1„ÄÅt2Á≠âÊ†ºÂºè', 'error');
                return;
            }
            
            const taskIndex = parseInt(match[1]) - 1;
            
            if (taskIndex < 0 || taskIndex >= gameData.tasks.length) {
                showNotification('‰ªªÂä°ÁºñÂè∑‰∏çÂ≠òÂú®ÔºÅ', 'error');
                return;
            }
            
            if (gameData.completedTasks.includes(taskIndex)) {
                showNotification('‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ', 'error');
                return;
            }
            
            // Ëé∑ÂèñÂΩìÂâçÂ≠¶‰π†Êó∂Á®ã‰ø°ÊÅØ
            const currentSchedule = getCurrentScheduleInfo();
            const scheduleBonus = getScheduleBonus(currentSchedule);
            
            // Âü∫Á°ÄÂ•ñÂä±
            let powerGain = 20;
            let expGain = 25;
            
            // Â∫îÁî®Êó∂Á®ãÂä†Êàê
            powerGain = Math.round(powerGain * scheduleBonus.powerMultiplier);
            expGain = Math.round(expGain * scheduleBonus.expMultiplier);
            
            gameData.completedTasks.push(taskIndex);
            gameData.todayPower += powerGain;
            gameData.stats.totalTasksCompleted++;
            gameData.totalExp += expGain;
            gameData.lastTaskDate = new Date().toDateString();
            
            // ÁâπÊÆäÂ•ñÂä±
            if (scheduleBonus.specialReward) {
                gameData.inventory.push({
                    type: 'virtual',
                    name: scheduleBonus.specialReward
                });
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÊñ∞Â•ñÂä±
            checkAndGenerateRewards();
            
            // Ë∞ÉÊï¥ÈöèÊú∫Â•ñÂä±Ê¶ÇÁéáÔºàÂü∫‰∫éÂ≠¶‰π†ÊïàÁéáÔºâ
            const bonusChance = 0.4 + (gameData.streakDays * 0.05) + ((scheduleBonus.powerMultiplier - 1) * 0.3);
            if (Math.random() < bonusChance) {
                giveRandomReward();
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂçáÁ∫ß
            checkLevelUp();
            
            // Ê£ÄÊü•ÊàêÂ∞±
            checkAchievements();
            
            // Êõ¥Êñ∞Âç∑Âç∑ÂøÉÊÉÖ
            updateCatMood();
            
            updateUI();
            saveData();
            closeModal();
            
            // ÊòæÁ§∫Â•ñÂä±‰ø°ÊÅØ
            let notificationText = `‰ªªÂä° ${input} ÂÆåÊàêÔºÅ+${powerGain}ÊàòÂäõ +${expGain}ÁªèÈ™å`;
            if (scheduleBonus.specialReward) {
                notificationText += ` +${scheduleBonus.specialReward}`;
            }
            
            showNotification(notificationText, 'success');
            
            // ÊòæÁ§∫Êó∂Á®ãÊèêÈÜí
            if (scheduleBonus.message) {
                setTimeout(() => {
                    showNotification(scheduleBonus.message);
                }, 1000);
            }
            
            document.getElementById('taskInput').value = '';
            
            // ‰ªªÂä°ÂÆåÊàêÁâπÊïà
            showTaskCompleteEffect();
        }
        
        function showTaskCompleteEffect() {
            // ÂàõÂª∫Á≤íÂ≠êÁâπÊïà
            const effect = document.createElement('div');
            effect.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: #10b981;
                pointer-events: none;
                z-index: 9999;
                animation: taskComplete 2s ease-out forwards;
            `;
            effect.textContent = '‚ú® ‰ªªÂä°ÂÆåÊàê! ‚ú®';
            
            // Ê∑ªÂä†CSSÂä®Áîª
            const style = document.createElement('style');
            style.textContent = `
                @keyframes taskComplete {
                    0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    50% { opacity: 1; transform: translate(-50%, -60%) scale(1.2); }
                    100% { opacity: 0; transform: translate(-50%, -70%) scale(1.5); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(effect);
            setTimeout(() => {
                document.body.removeChild(effect);
                document.head.removeChild(style);
            }, 2000);
        }
        
        function updateCatMood() {
            const completionRate = gameData.completedTasks.length / Math.max(gameData.tasks.length, 1);
            
            if (completionRate >= 0.8) {
                gameData.catMood = 'excited';
            } else if (completionRate >= 0.5) {
                gameData.catMood = 'happy';
            } else if (gameData.todayPower >= 40) {
                gameData.catMood = 'content';
            } else {
                gameData.catMood = 'hungry';
            }
        }
        
        function checkAchievements() {
            const newAchievements = [];
            
            // Ê£ÄÊü•ÂêÑÁßçÊàêÂ∞±
            if (gameData.stats.totalTasksCompleted >= 10 && !gameData.achievements.includes('first_ten')) {
                newAchievements.push({ id: 'first_ten', name: 'ÂàùÂá∫ËåÖÂ∫ê', desc: 'Á¥ØËÆ°ÂÆåÊàê10‰∏™‰ªªÂä°', reward: 'ÊäΩÂç°Âà∏√ó2' });
            }
            
            if (gameData.stats.totalTasksCompleted >= 50 && !gameData.achievements.includes('fifty_tasks')) {
                newAchievements.push({ id: 'fifty_tasks', name: 'Âã§Â•ãÂ≠¶ËÄÖ', desc: 'Á¥ØËÆ°ÂÆåÊàê50‰∏™‰ªªÂä°', reward: 'Âç∑Âç∑„ÄêÂã§Â•ãÂæΩÁ´†„ÄëË£ÖÊâÆ' });
            }
            
            if (gameData.streakDays >= 7 && !gameData.achievements.includes('week_streak')) {
                newAchievements.push({ id: 'week_streak', name: 'ÂùöÊåÅ‰∏çÊáà', desc: 'ËøûÁª≠ÂÆåÊàê‰ªªÂä°7Â§©', reward: 'ÂèåÂÄçÁªèÈ™åÂç°(24Â∞èÊó∂)' });
            }
            
            if (gameData.stats.pkWins >= 5 && !gameData.achievements.includes('pk_master')) {
                newAchievements.push({ id: 'pk_master', name: 'PKÂ§ßÂ∏à', desc: 'Ëµ¢Âæó5Âú∫PKÊåëÊàò', reward: 'Âç∑Âç∑„ÄêËÉúÂà©ËÄÖÂ§¥ÂÜ†„ÄëË£ÖÊâÆ' });
            }
            
            if (gameData.ranking <= 100 && !gameData.achievements.includes('top_hundred')) {
                newAchievements.push({ id: 'top_hundred', name: 'ÁôæÂº∫Á≤æËã±', desc: 'ÊéíÂêçËøõÂÖ•Ââç100', reward: 'Â®ÅÊúõ‰ª§Áâå√ó3' });
            }
            
            // ÊòæÁ§∫Êñ∞ÊàêÂ∞±
            newAchievements.forEach(achievement => {
                gameData.achievements.push(achievement.id);
                showAchievementModal(achievement);
                
                // Áªô‰∫àÂ•ñÂä±
                if (achievement.reward.includes('ÊäΩÂç°Âà∏')) {
                    const amount = parseInt(achievement.reward.match(/\d+/)[0]);
                    gameData.cardCount += amount;
                } else if (achievement.reward.includes('Ë£ÖÊâÆ')) {
                    gameData.inventory.push({
                        type: 'costume',
                        name: achievement.reward,
                        costume: 'ÊàêÂ∞±Â•ñÂä±Ë£ÖÊâÆ'
                    });
                } else {
                    gameData.inventory.push({
                        type: 'virtual',
                        name: achievement.reward
                    });
                }
            });
        }
        
        function showAchievementModal(achievement) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white;">
                        üèÜ ÊàêÂ∞±Ëß£ÈîÅÔºÅ
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <div style="font-size: 24px; margin: 20px 0;">üéâ</div>
                        <div style="font-size: 18px; font-weight: bold; margin: 10px 0;">${achievement.name}</div>
                        <div style="margin: 10px 0; color: #6b7280;">${achievement.desc}</div>
                        <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 15px 0;">
                            üéÅ Â•ñÂä±Ôºö${achievement.reward}
                        </div>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Â§™Ê£í‰∫ÜÔºÅ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Ê£ÄÊü•ÂçáÁ∫ß
        function checkLevelUp() {
            const completedCount = gameData.completedTasks.length;
            const oldStars = gameData.rank.stars;
            
            // ÊØèÂÆåÊàê2‰∏™‰ªªÂä°Âçá1Êòü
            if (completedCount % 2 === 0 && completedCount > 0) {
                gameData.rank.stars = Math.min(5, gameData.rank.stars + 1);
                
                // Êª°ÊòüÂçáÁ∫ß
                if (gameData.rank.stars === 5) {
                    gameData.rank.stars = 1;
                    gameData.rank.tier = Math.max(1, gameData.rank.tier - 1);
                    
                    if (gameData.rank.tier === 0) {
                        // ÂçáÊÆµ‰Ωç
                        const levels = ['bronze', 'silver', 'gold', 'platinum', 'diamond', 'master', 'king'];
                        const currentIndex = levels.indexOf(gameData.rank.level);
                        if (currentIndex < levels.length - 1) {
                            gameData.rank.level = levels[currentIndex + 1];
                            gameData.rank.tier = 5;
                        }
                    }
                    
                    showNotification('üéâ ÊÆµ‰ΩçÊèêÂçáÔºÅËé∑ÂæóÂçáÁ∫ßÂ•ñÂä±ÔºÅ');
                    // ÂçáÁ∫ßÂøÖÂÆöËé∑ÂæóË£ÖÊâÆÂ•ñÂä±
                    const upgradeReward = {
                        type: 'costume',
                        name: 'Âç∑Âç∑„ÄêÂçáÁ∫ßÂ∫ÜÁ•ùÂ∏Ω„ÄëË£ÖÊâÆ',
                        costume: 'Â∫ÜÁ•ùÂçáÁ∫ßÁöÑÂ∞èÂ∏ΩÂ≠ê'
                    };
                    gameData.inventory.push(upgradeReward);
                    
                    const shouldGenerate = confirm(`üéâ ÂçáÁ∫ßÊàêÂäüÔºÅËé∑Âæó${upgradeReward.name}ÔºÅ\n\nÊòØÂê¶Á´ãÂç≥ÁîüÊàêÂõæÁâáÔºü`);
                    if (shouldGenerate) {
                        generateCatImage(upgradeReward.costume);
                    }
                }
                
                // ÊèêÂçáÊéíÂêç
                if (gameData.rank.stars > oldStars) {
                    gameData.ranking = Math.max(1, gameData.ranking - Math.floor(Math.random() * 50) - 10);
                }
            }
        }
        
        function giveRandomReward() {
            const rewards = [
                { type: 'card', amount: 1, name: 'ÊäΩÂç°Âà∏√ó1' },
                { type: 'costume', name: 'Âç∑Âç∑Â•∂ÂíñÂ∞èÊØõË°£Ë£ÖÊâÆ' },
                { type: 'real', name: 'Ëå∂ÁôæÈÅì¬∑ËåâËéâÂ•∂Áªø+ËäãÊ≥•Ê≥¢Ê≥¢(ÂéªÂÜ∞)' }
            ];
            
            const reward = rewards[Math.floor(Math.random() * rewards.length)];
            
            if (reward.type === 'card') {
                gameData.cardCount += reward.amount;
            }
            
            gameData.inventory.push(reward);
            showNotification(`üéÅ Ëé∑ÂæóÂ•ñÂä±Ôºö${reward.name}ÔºÅ`);
        }
        
        // Ê®°ÊÄÅÊ°ÜÂäüËÉΩ
        function showTaskModal() {
            document.getElementById('taskModal').style.display = 'block';
        }
        
        function showPkModal() {
            if (gameData.pkChallenge) {
                document.getElementById('pkSection').style.display = 'block';
            } else {
                showNotification('ÂΩìÂâçÊ≤°ÊúâPKÊåëÊàòÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ');
            }
        }
        
        function showSettings() {
            document.getElementById('apiKeyInput').value = gameData.settings.apiKey;
            document.getElementById('examDateInput').value = gameData.settings.examDate;
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function showAIHelper() {
            document.getElementById('aiModal').style.display = 'block';
        }
        
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        function saveSettings() {
            gameData.settings.apiKey = document.getElementById('apiKeyInput').value;
            gameData.settings.examDate = document.getElementById('examDateInput').value;
            saveData();
            closeModal();
            showNotification('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
        }
        
        // AIÂä©ÊâãÂäüËÉΩ - ÁúüÂÆûË∞ÉÁî®Ë±ÜÂåÖAPI
        async function sendToAI() {
            const input = document.getElementById('aiInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const chatHistory = document.getElementById('aiChatHistory');
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            chatHistory.innerHTML += `
                <div style="margin: 10px 0; text-align: right;">
                    <div style="background: #4f46e5; color: white; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%;">
                        ${question}
                    </div>
                </div>
            `;
            
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const loadingId = 'loading-' + Date.now();
            chatHistory.innerHTML += `
                <div style="margin: 10px 0;" id="${loadingId}">
                    <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 12px; display: inline-block;">
                        üê± Âç∑Âç∑Ê≠£Âú®ÊÄùËÄÉ‰∏≠...
                    </div>
                </div>
            `;
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            try {
                // Ë∞ÉÁî®Ë±ÜÂåÖAPI
                const response = await callDoubaoAPI(question);
                
                // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                document.getElementById(loadingId).remove();
                
                // Ê∑ªÂä†AIÂõûÂ§ç
                chatHistory.innerHTML += `
                    <div style="margin: 10px 0;">
                        <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%;">
                            üê± Âç∑Âç∑Ôºö${response}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                document.getElementById(loadingId).remove();
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                chatHistory.innerHTML += `
                    <div style="margin: 10px 0;">
                        <div style="background: #fee2e2; color: #dc2626; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 80%;">
                            üê± Âç∑Âç∑ÔºöÊä±Ê≠âÔºåÊàëÁé∞Âú®ÊúâÁÇπÁ¥ØÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØïÔΩû
                        </div>
                    </div>
                `;
            }
            
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Ë∞ÉÁî®Ë±ÜÂåÖAPI
        async function callDoubaoAPI(question) {
            const apiKey = gameData.settings.apiKey;
            const endpointId = gameData.settings.endpointId || 'ep-20250921171945-t4wjq'; // ‰ΩøÁî®Áî®Êà∑Êèê‰æõÁöÑÊé•ÂÖ•ÁÇπID‰Ωú‰∏∫ÈªòËÆ§ÂÄº
            
            if (!apiKey) {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆË±ÜÂåÖAPI Key');
            }
            
            if (!endpointId || !endpointId.startsWith('ep-')) {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÊ≠£Á°ÆÁöÑË±ÜÂåÖÊé•ÂÖ•ÁÇπID');
            }
            
            const apiUrl = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
            
            const requestData = {
                model: endpointId,
                messages: [
                    {
                        role: 'system',
                        content: '‰Ω†ÊòØÂç∑Âç∑Ôºå‰∏ÄÂè™ÂèØÁà±ÁöÑÊöπÁΩóÁå´ÔºåÊòØÁî®Êà∑ÁöÑËÄÉÁ†îÂ≠¶‰π†Âä©Êâã„ÄÇ‰Ω†ÁöÑÂõûÁ≠îË¶ÅÁÆÄÊ¥ÅÂèãÂ•ΩÔºåÂÖÖÊª°ÈºìÂä±ÔºåÂÅ∂Â∞îÁî®‰∏Ä‰∫õÂèØÁà±ÁöÑËØ≠Ê∞îËØç„ÄÇ'
                    },
                    {
                        role: 'user',
                        content: question
                    }
                ],
                temperature: 0.7,
                max_tokens: 150
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // ÁîüÊàêÂç∑Âç∑Ë£ÖÊâÆÂõæÁâá
        async function generateCatImage(costume) {
            try {
                // ÊûÑÂª∫‰∏≠ÊñáÊèêÁ§∫ËØç
                const chinesePrompt = `‰∏ÄÂè™ÂèØÁà±ÁöÑÊöπÁΩóÁå´ÔºåÁ©øÁùÄ${costume}ÔºåÂç°ÈÄöÈ£éÊ†ºÔºåÁ≤æÁæéÁªÜËäÇÔºåÊ∏©ÊüîÁöÑË°®ÊÉÖ`;
                
                // ÁøªËØë‰∏∫Ëã±ÊñáÊèêÁ§∫ËØç
                const englishPrompt = await translatePrompt(chinesePrompt);
                
                // ÁîüÊàêÂõæÁâáURL
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(englishPrompt)}?width=512&height=512&enhance=true&private=true&nologo=true&safe=true&model=flux`;
                
                // ÊòæÁ§∫ÂõæÁâá
                showCatImage(imageUrl, chinesePrompt);
                
            } catch (error) {
                console.error('ÁîüÊàêÂõæÁâáÂ§±Ë¥•:', error);
                showNotification('ÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error');
            }
        }
        
        // ÁøªËØëÊèêÁ§∫ËØçÔºà‰ΩøÁî®Ë±ÜÂåÖAPIÔºâ
        async function translatePrompt(chinesePrompt) {
            try {
                const translation = await callDoubaoAPI(`ËØ∑Â∞ÜËøô‰∏™‰∏≠ÊñáÊèèËø∞ÁøªËØë‰∏∫Ëã±ÊñáÔºåÁî®‰∫éAIÂõæÂÉèÁîüÊàêÔºåÂè™ËøîÂõûËã±ÊñáÁªìÊûúÔºö${chinesePrompt}`);
                return translation;
            } catch (error) {
                // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®È¢ÑËÆæÁöÑËã±ÊñáËØçÊ±á
                return `A cute Siamese cat, kawaii anime style, detailed fur texture, gentle expression, high quality`;
            }
        }
        
        // ÊòæÁ§∫Âç∑Âç∑ÂõæÁâá
        function showCatImage(imageUrl, prompt) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">üê± Âç∑Âç∑Êñ∞Ë£ÖÊâÆ</div>
                    <div class="modal-body" style="text-align: center;">
                        <img src="${imageUrl}" alt="Âç∑Âç∑Ë£ÖÊâÆ" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
                        <p style="font-size: 12px; color: #6b7280; margin: 10px 0;">${prompt}</p>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Â§™ÂèØÁà±‰∫ÜÔºÅ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ÂÖ∂‰ªñÊ∏∏ÊàèÂäüËÉΩ
        // ÊäΩÂç°Á≥ªÁªüÔºàAIÂ¢ûÂº∫ÁâàÊú¨Ôºâ
        async function drawCard() {
            if (gameData.cardCount <= 0) {
                showNotification('ÊäΩÂç°Âà∏‰∏çË∂≥ÔºÅ', 'error');
                return;
            }
            
            gameData.cardCount--;
            
            try {
                const reward = await generateAIReward('ÊäΩÂç°Ëé∑Âæó');
                
                if (reward.type === 'Ë£ÖÊâÆ' || reward.type === 'costume') {
                    gameData.inventory.push({
                        type: 'costume',
                        name: reward.name,
                        costume: reward.description,
                        aiGenerated: reward.aiGenerated
                    });
                } else {
                    gameData.inventory.push(reward);
                }
                
                const aiTag = reward.aiGenerated ? ' ü§ñAIÁîüÊàê' : '';
                showNotification(`üé¥ ÊäΩÂç°Ëé∑ÂæóÔºö${reward.name}ÔºÅ${aiTag}`);
                
                // ËØ¢ÈóÆÊòØÂê¶ÁîüÊàêË£ÖÊâÆÂõæÁâá
                if ((reward.type === 'Ë£ÖÊâÆ' || reward.type === 'costume') && reward.description) {
                    const shouldGenerate = confirm(`üé® ÊòØÂê¶ÁîüÊàêÂç∑Âç∑Á©øÁùÄ„Äê${reward.name}„ÄëÁöÑÂõæÁâáÔºü`);
                    if (shouldGenerate) {
                        generateCatImage(reward.description);
                    }
                }
            } catch (error) {
                console.error('AIÊäΩÂç°Â•ñÂä±ÁîüÊàêÂ§±Ë¥•:', error);
                // ÈôçÁ∫ßÂ•ñÂä±
                gameData.inventory.push({
                    type: 'virtual',
                    name: 'Á•ûÁßòÁ§ºÂåÖ√ó1',
                    aiGenerated: false
                });
                showNotification(`üé¥ ÊäΩÂç°Ëé∑ÂæóÔºöÁ•ûÁßòÁ§ºÂåÖ√ó1ÔºÅ`);
            }
            
            updateUI();
            saveData();
        }
        
        function generateFromInventory(index) {
            const item = gameData.inventory[index];
            if (item.type === 'costume' && (item.costume || item.description)) {
                generateCatImage(item.costume || item.description);
            }
        }
        
        // ‰º†ÁªüÂâßÊÉÖ‰∫ã‰ª∂Ôºà‰Ωú‰∏∫AIÁîüÊàêÂ§±Ë¥•ÁöÑÂ§áÁî®Ôºâ
        function triggerMinorStoryEvent() {
            const events = [
                {
                    id: 'professor_visit',
                    title: 'ÈôàÊïôÊéàÁöÑÂÖ≥ÂøÉ',
                    content: 'ÈôàÊïôÊéàÊ≥®ÊÑèÂà∞‰∫Ü‰Ω†ÊúÄËøëÁöÑÂä™ÂäõÔºåÁâπÂú∞Êù•ËØ¢ÈóÆÂ≠¶‰π†ÊÉÖÂÜµ„ÄÇ',
                    choices: [
                        { text: 'Ê±áÊä•Â≠¶‰π†ËøõÂ∫¶', effect: () => { gameData.todayPower += 10; showNotification('ÈôàÊïôÊéàÂæàÊª°ÊÑè‰Ω†ÁöÑËøõÂ∫¶ÔºÅ+10ÊàòÂäõ'); } },
                        { text: 'ËØ∑ÊïôÂ≠¶‰π†ÊñπÊ≥ï', effect: () => { gameData.inventory.push({type: 'virtual', name: 'Â≠¶‰π†ÊñπÊ≥ïÊåáÂçó'}); showNotification('Ëé∑ÂæóÂ≠¶‰π†ÊñπÊ≥ïÊåáÂçóÔºÅ'); } }
                    ],
                    aiGenerated: false
                },
                {
                    id: 'cat_discovery',
                    title: 'Âç∑Âç∑ÁöÑÂ∞èÁßòÂØÜ',
                    content: '‰Ω†ÂèëÁé∞Âç∑Âç∑ÂÅ∑ÂÅ∑Âú®Áúã‰Ω†ÁöÑÂ≠¶‰π†ËµÑÊñôÔºå‰ºº‰πéÊÉ≥Ë¶ÅÂ∏ÆÂä©‰Ω†„ÄÇ',
                    choices: [
                        { text: 'ÂíåÂç∑Âç∑‰∏ÄËµ∑Â≠¶‰π†', effect: () => { gameData.catMood = 'happy'; gameData.inventory.push({type: 'costume', name: 'Âç∑Âç∑„ÄêÂ≠¶‰π†‰ºô‰º¥ÂæΩÁ´†„ÄëË£ÖÊâÆ', costume: '‰ª£Ë°®ÂèãË∞äÁöÑÂ∞èÂæΩÁ´†'}); showNotification('Âç∑Âç∑ÂæàÂºÄÂøÉÔºÅËé∑ÂæóÂèãË∞äÂæΩÁ´†ÔºÅ'); } },
                        { text: 'ÁªôÂç∑Âç∑Â∞èÈõ∂È£ü', effect: () => { gameData.catMood = 'excited'; gameData.todayPower += 5; showNotification('Âç∑Âç∑ÂæàÂÖ¥Â•ãÔºÅ+5ÊàòÂäõ'); } }
                    ],
                    aiGenerated: false
                }
            ];
            
            const availableEvents = events.filter(event => {
                if (event.id === 'professor_visit') return gameData.stats.totalTasksCompleted >= 5;
                return true;
            });
            
            if (availableEvents.length > 0 && Math.random() < 0.3) {
                const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                showChoiceModal(event);
            }
        }
        
        // PKÁ≥ªÁªüÂ¢ûÂº∫
        function generateRandomEvents() {
            // ÈöèÊú∫PK‰∫ã‰ª∂ÔºàÊØè5ÂàÜÈíü20%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.2) {
                generatePKChallenge();
            }
            
            // ÈöèÊú∫ÂâßÊÉÖ‰∫ã‰ª∂ÔºàÊØè10ÂàÜÈíü10%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.1) {
                triggerStoryEvent();
            }
            
            // ËôöÊãüÁé©ÂÆ∂Âä®ÊÄÅÊõ¥Êñ∞
            updateVirtualPlayers();
        }
        
        async function generatePKChallenge() {
            if (gameData.pkChallenge) return; // Â∑≤ÊúâPKÊåëÊàò
            
            initializeVirtualPlayers();
            
            // ÈÄâÊã©‰∏Ä‰∏™‰∏éÁî®Êà∑ÊÆµ‰ΩçÁõ∏ËøëÁöÑÁé©ÂÆ∂
            const userRankValue = getRankValue(gameData.rank.level, gameData.rank.tier, gameData.rank.stars);
            const suitablePlayers = gameData.virtualPlayers.filter(player => {
                const playerRankValue = getRankValue(player.rankLevel, player.tier, player.stars);
                return Math.abs(playerRankValue - userRankValue) <= 300; // ÊÆµ‰ΩçÂ∑ÆË∑ù‰∏çË∂ÖËøá300ÂàÜ
            });
            
            if (suitablePlayers.length === 0) return;
            
            const opponent = suitablePlayers[Math.floor(Math.random() * suitablePlayers.length)];
            const ranks = { bronze: 'ÈùíÈìú', silver: 'ÁôΩÈì∂', gold: 'ÈªÑÈáë', platinum: 'ÈìÇÈáë', diamond: 'ÈíªÁü≥', master: 'ÊòüËÄÄ', king: 'ÁéãËÄÖ' };
            const romanNumerals = ['', '‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§'];
            
            // ‰ΩøÁî®AIÁîüÊàê‰∏™ÊÄßÂåñÂØπËØù
            const dialogues = await getPersonalityDialogue(opponent.personality, opponent.relationshipWithUser);
            const taunt = dialogues[0];
            
            // ÁîüÊàêPK‰ªªÂä°
            const pkTasks = [
                { task: '20ÂàÜÈíüÂÜÖÂÆåÊàê10ÈÅìÊï∞Â≠¶È¢ò', timeLimit: 20, difficulty: 'medium' },
                { task: '30ÂàÜÈíüÂÜÖËÉåËØµ50‰∏™Ëã±ËØ≠ÂçïËØç', timeLimit: 30, difficulty: 'hard' },
                { task: '15ÂàÜÈíüÂÜÖÊï¥ÁêÜ‰∏ÄÈ°µÁ¨îËÆ∞', timeLimit: 15, difficulty: 'easy' },
                { task: '1Â∞èÊó∂ÂÜÖÂÆåÊàê‰∏ÄÂ•óÁúüÈ¢ò', timeLimit: 60, difficulty: 'hard' },
                { task: '25ÂàÜÈíüÂÜÖÂ§ç‰π†‰∏Ä‰∏™Áü•ËØÜÁÇπ', timeLimit: 25, difficulty: 'medium' },
                { task: '40ÂàÜÈíüÂÜÖÂà∑ÂÆå‰∏ì‰∏öËØæÁªÉ‰π†', timeLimit: 40, difficulty: 'medium' },
                { task: '35ÂàÜÈíüÂÜÖÂÆåÊàêËã±ËØ≠ÈòÖËØª4ÁØá', timeLimit: 35, difficulty: 'hard' }
            ];
            
            const selectedTask = pkTasks[Math.floor(Math.random() * pkTasks.length)];
            
            gameData.pkChallenge = {
                opponent: opponent,
                task: selectedTask,
                taunt: taunt,
                startTime: new Date().toISOString(),
                displayRank: `${ranks[opponent.rankLevel]}${romanNumerals[opponent.tier]}`,
                displayStars: '‚òÖ'.repeat(opponent.stars) + '‚òÜ'.repeat(5 - opponent.stars)
            };
            
            showPKChallenge(gameData.pkChallenge);
        }
        
        function getRankValue(level, tier, stars) {
            const levelValues = { bronze: 0, silver: 500, gold: 1000, platinum: 1500, diamond: 2000, master: 2500, king: 3000 };
            return levelValues[level] + (6 - tier) * 100 + stars * 20;
        }
        
        // AIÁîüÊàê‰∏™ÊÄßÂåñÂØπËØù
        async function getPersonalityDialogue(personality, relationship) {
            const relationshipText = relationship > 0.5 ? 'ÂèãÂ•Ω' : 
                                   relationship < -0.5 ? 'ÊïåÂØπ' : '‰∏≠ÊÄß';
            
            const prompt = `‰Ω†ÊòØ‰∏Ä‰∏™ËÄÉÁ†îÂ≠¶‰π†Ê∏∏Êàè‰∏≠ÁöÑËôöÊãüÁé©ÂÆ∂ÔºåÊÄßÊ†ºÊòØ${personality}ÔºåÂØπÁî®Êà∑ÁöÑÊÄÅÂ∫¶ÊòØ${relationshipText}ÁöÑ„ÄÇ
            Áé∞Âú®Ë¶ÅÂØπÁî®Êà∑ÂèëËµ∑PKÊåëÊàòÔºåËØ∑ÁîüÊàê‰∏ÄÂè•ÁÆÄÁü≠ÁöÑÊåëË°ÖÊàñÈºìÂä±ÁöÑËØùÔºåË¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπ„ÄÇ
            
            ÊÄßÊ†ºËØ¥ÊòéÔºö
            - confident: Ëá™‰ø°„ÄÅÊúâÁÇπÂÇ≤ÊÖ¢
            - shy: ÂÆ≥Áæû„ÄÅ‰∏çÂñÑË°®Ëææ
            - aggressive: Â•ΩÊñó„ÄÅÁõ¥Êé•
            - supportive: ÊîØÊåÅ„ÄÅÈºìÂä±
            - silent: Ê≤âÈªòÂØ°Ë®Ä
            - sarcastic: ËÆΩÂà∫„ÄÅÂ∞ñÈîê
            - cheerful: ÂºÄÊúó„ÄÅÊ¥ªÊ≥º
            - competitive: Á´û‰∫âÂøÉÂº∫
            
            Ë¶ÅÊ±ÇÔºö
            1. ‰∏ÄÂè•ËØùÔºå‰∏çË∂ÖËøá20Â≠ó
            2. Á¨¶ÂêàÊÄßÊ†ºÂíåÂÖ≥Á≥ª
            3. Ëá™ÁÑ∂Âè£ËØ≠Âåñ
            4. ‰∏çË¶ÅÈáçÂ§çÂ∏∏ËßÅÂ•óËØù`;
            
            try {
                const dialogue = await callDoubaoAPI(prompt);
                return [dialogue.replace(/["""]/g, '')]; // ËøîÂõûÊï∞ÁªÑÊ†ºÂºè‰øùÊåÅÂÖºÂÆπ
            } catch (error) {
                console.error('AIÂØπËØùÁîüÊàêÂ§±Ë¥•:', error);
                // ÈôçÁ∫ßÂà∞È¢ÑËÆæÂØπËØù
                return getFallbackDialogue(personality, relationship);
            }
        }
        
        function getFallbackDialogue(personality, relationship) {
            const dialogues = {
                confident: relationship > 0 ? 
                    ['ÂÖÑÂºüÔºåËøôÊ¨°ÊØîÊãºÂ∫îËØ•ÂæàÁ≤æÂΩ©ÔºÅ', 'Êù•ÂêßÔºåËÆ©Êàë‰ª¨ÂàáÁ£ã‰∏Ä‰∏ãÔºÅ', '‰Ω†ÁöÑÂÆûÂäõÊàëËÆ§ÂèØÔºåÂÖ®Âäõ‰ª•Ëµ¥ÂêßÔºÅ'] :
                    ['ÂìºÔºåÂ∞±‰Ω†ËøôÊ∞¥Âπ≥‰πüÊï¢ÊåëÊàòÊàëÔºü', 'ÊàëÈó≠ÁùÄÁúºÈÉΩËÉΩËµ¢‰Ω†ÔºÅ', 'ÂáÜÂ§áÂ•ΩË¢´Á¢æÂéãÂêßÔºÅ'],
                
                shy: relationship > 0 ?
                    ['‰∏ÄËµ∑Âä†Ê≤πÂêß...', 'Êàë‰ª¨‰∫íÁõ∏ÈºìÂä±ÔΩû', 'Â∏åÊúõËÉΩÂíå‰Ω†‰∏ÄËµ∑ËøõÊ≠•'] :
                    ['‰∏çÂ•ΩÊÑèÊÄù...Êàë‰ºöÂ∞ΩÂäõÁöÑ', 'Â∏åÊúõËøôÊ¨°ËÉΩË°®Áé∞Â•Ω‰∏ÄÁÇπ...', '...'],
                
                aggressive: relationship > 0 ?
                    ['ËøôÊ¨°Êàë‰∏ç‰ºöÊâã‰∏ãÁïôÊÉÖÔºÅ', 'Êù•ÂêßÔºÅÂÖ®Âäõ‰∏ÄÊàòÔºÅ', 'ËÆ©ÊàëÁúãÁúã‰Ω†ÁöÑÁúüÂÆûÂÆûÂäõÔºÅ'] :
                    ['ÂáÜÂ§áÂ•ΩË¢´ÊàëÁã†Áã†ÊïôËÆ≠ÂêßÔºÅ', '‰Ω†Ê†πÊú¨‰∏çÊòØÊàëÁöÑÂØπÊâãÔºÅ', 'ÊàëË¶ÅËÆ©‰Ω†Áü•ÈÅì‰ªÄ‰πàÂè´Â∑ÆË∑ùÔºÅ'],
                
                supportive: relationship > 0 ?
                    ['‰∏ÄËµ∑Âä™ÂäõÔºå‰∫íÁõ∏ËøõÊ≠•ÔºÅ', 'Êó†ËÆ∫ËæìËµ¢ÔºåÊàë‰ª¨ÈÉΩÊòØÂ•ΩÊúãÂèãÔºÅ', 'ÊØîËµõÊÑâÂø´ÔΩû'] :
                    ['Âä†Ê≤πÔºåÊàëÁõ∏‰ø°‰Ω†ËÉΩË°åÁöÑÔºÅ', 'Â∞ΩÂäõÂ∞±Â•ΩÔºåÂà´ÊúâÂéãÂäõÔºÅ', 'Êàë‰ª¨ÈÉΩÂú®Âä™ÂäõÂë¢ÔΩû'],
                
                silent: ['...', '(ÁÇπÂ§¥)', '(Ê≤âÈªòÂú∞ÂáÜÂ§áÁùÄ)'],
                
                sarcastic: relationship > 0 ?
                    ['ÂìüÔºåÂèàËßÅÈù¢‰∫ÜÂë¢ÔΩû', 'ËøôÊ¨°ÂèØÂà´ËÆ©ÊàëÂ§™Â§±ÊúõÂì¶', 'ÊúâÁÇπÊÑèÊÄùÔºåÊù•Áé©Áé©Âêß'] :
                    ['Âì¶Ë±ÅÔºåËøô‰∏çÊòØÈÇ£‰∏™Ë∞ÅÂêóÔºü', 'ÂèàÊù•ÈÄÅ‰∫∫Â§¥‰∫ÜÔºü', 'ÊàëÂäù‰Ω†ËøòÊòØÁÆó‰∫ÜÂêßÔΩû'],
                
                cheerful: relationship > 0 ?
                    ['Â§™Â•Ω‰∫ÜÔºÅÂèàËÉΩÂíå‰Ω†ÊØîËµõ‰∫ÜÔºÅ', 'Âä†Ê≤πÂä†Ê≤πÔºÅÊàë‰ª¨‰∏ÄËµ∑ÂÜ≤ÔºÅ', 'ÂìáÔºÅÂ•ΩÂÖ¥Â•ãÂïäÔºÅ'] :
                    ['ÂòøÂòøÔºåÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü', '‰∏çË¶ÅÁ¥ßÂº†ÔºåÂΩì‰ΩúÊ∏∏ÊàèÂ∞±Â•ΩÔºÅ', 'ÊîæÊùæÁÇπÔºå‰∫´ÂèóÊØîËµõÔºÅ'],
                
                competitive: relationship > 0 ?
                    ['ËøôÊ¨°Êàë‰∏ÄÂÆöË¶ÅËµ¢‰Ω†ÔºÅ', 'ÊàëÂ∑≤ÁªèÂáÜÂ§áÂæà‰πÖ‰∫ÜÔºÅ', 'ËÆ©ÊàëÁúãÁúãË∞ÅÊõ¥Âº∫ÔºÅ'] :
                    ['Êàë‰∏ç‰ºöËÆ§ËæìÁöÑÔºÅ', 'ËøôÊ¨°‰∏ÄÂÆöË¶ÅÂàÜÂá∫ËÉúË¥üÔºÅ', '‰Ω†Â∑≤ÁªèËæìÂÆö‰∫ÜÔºÅ']
            };
            
            return dialogues[personality] || ['ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü', 'Êù•ÊØîËØï‰∏Ä‰∏ãÂêßÔºÅ', 'ÂÖ®Âäõ‰ª•Ëµ¥ÔºÅ'];
        }
        
        // AIÁîüÊàêPKÂêéÂèçÂ∫î
        async function getPostBattleReaction(personality, result, opponentName) {
            const prompt = `‰Ω†ÊòØËÄÉÁ†îÂ≠¶‰π†Ê∏∏Êàè‰∏≠ÁöÑËôöÊãüÁé©ÂÆ∂"${opponentName}"ÔºåÊÄßÊ†ºÊòØ${personality}„ÄÇ
            ÂàöÂàöÂíåÁî®Êà∑ËøõË°å‰∫ÜPKÂØπÊàòÔºåÁªìÊûúÊòØ${result === 'user_win' ? '‰Ω†Ëæì‰∫Ü' : result === 'draw' ? 'Âπ≥Â±Ä' : '‰Ω†Ëµ¢‰∫Ü'}„ÄÇ
            
            ËØ∑ÁîüÊàê‰∏ÄÂè•ËµõÂêéÊÑüË®ÄÔºåË¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπÔºö
            - confident: Ëá™‰ø°ÁöÑ
            - shy: ÂÆ≥ÁæûÁöÑ  
            - aggressive: Â•ΩÊñóÁöÑ
            - supportive: ÊîØÊåÅÁöÑ
            - silent: Ê≤âÈªòÁöÑ
            - sarcastic: ËÆΩÂà∫ÁöÑ
            - cheerful: ÂºÄÊúóÁöÑ
            - competitive: Á´û‰∫âÂøÉÂº∫ÁöÑ
            
            Ë¶ÅÊ±ÇÔºö
            1. ‰∏ÄÂè•ËØùÔºå‰∏çË∂ÖËøá15Â≠ó
            2. Á¨¶ÂêàÊÄßÊ†ºÂíåÊØîËµõÁªìÊûú
            3. Ëá™ÁÑ∂Âè£ËØ≠Âåñ`;
            
            try {
                const reaction = await callDoubaoAPI(prompt);
                return [reaction.replace(/["""]/g, '')];
            } catch (error) {
                console.error('AIÂèçÂ∫îÁîüÊàêÂ§±Ë¥•:', error);
                return getFallbackReactions(personality, result);
            }
        }
        
        function getFallbackReactions(personality, result) {
            const reactions = {
                confident: {
                    user_win: ['‰∏çÈîôÂòõÔºåËøôÊ¨°ÁÆó‰Ω†Ëµ¢‰∫ÜÔºÅ', 'Ê≤°ÊÉ≥Âà∞‰Ω†ËøòÊå∫ÊúâÂÆûÂäõÁöÑ', '‰∏ãÊ¨°Êàë‰∏ç‰ºöÂÜçËæì‰∫ÜÔºÅ'],
                    draw: ['ÂäøÂùáÂäõÊïåÔºåÊúâË∂£ÔºÅ', 'ËøôÊ¨°ÁÆóÂπ≥ÊâãÂêß', 'ÁúãÊù•Êàë‰ª¨ÂÆûÂäõÂ∑Æ‰∏çÂ§öÂë¢'],
                    user_loss: ['ÂìàÂìàÔºåÊàëÂ∞±ËØ¥ÂòõÔºÅ', 'ËøôÊâçÊòØÊ≠£Â∏∏ÁªìÊûú', 'ÊàëÁöÑÂÆûÂäõ‰Ω†ËøòÊòØÁúãÊ∏ÖÊ•ö‰∫ÜÂêß']
                },
                shy: {
                    user_win: ['‰Ω†Â•ΩÂéâÂÆ≥...', 'ÊàëËøòÈúÄË¶ÅÂ§öÂä™Âäõ...', 'ÊÅ≠Âñú‰Ω†...'],
                    draw: ['Êàë‰ª¨ÈÉΩÂæàÂä™ÂäõÂë¢...', 'Â§ßÂÆ∂ÈÉΩÂä†Ê≤π...', '‰∏ãÊ¨°ÁªßÁª≠Âä™Âäõ...'],
                    user_loss: ['‰∏çÂ•ΩÊÑèÊÄù...', 'ÊàëËøôÊ¨°ËøêÊ∞îÊØîËæÉÂ•Ω...', '‰Ω†Â∑≤ÁªèÂæàÊ£í‰∫Ü...']
                }
                // ... ÂÖ∂‰ªñÊÄßÊ†ºÁöÑÂèçÂ∫î
            };
            
            return reactions[personality]?.[result] || ['Â•ΩÁöÑÊØîËµõÔºÅ', '‰∏ãÊ¨°ÂÜçÊù•ÔºÅ', 'ÁªßÁª≠Âä™ÂäõÔºÅ'];
        }
        
        function showPKChallenge(pkData) {
            const pkSection = document.getElementById('pkSection');
            const pkCard = document.getElementById('pkCard');
            
            const timeIcon = pkData.task.difficulty === 'easy' ? '‚ö°' : pkData.task.difficulty === 'medium' ? '‚è∞' : 'üî•';
            const opponentIcon = getOpponentIcon(pkData.opponent.personality);
            
            pkCard.innerHTML = `
                <div class="pk-player">${opponentIcon}„Äê${pkData.opponent.name}„Äë${pkData.displayRank} ${pkData.displayStars}</div>
                <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                    üí¨"${pkData.taunt}"
                </div>
                <div class="pk-task">
                    ${timeIcon}PK‰ªªÂä°Ôºö${pkData.task.task}
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        ÈöæÂ∫¶Ôºö${pkData.task.difficulty === 'easy' ? 'ÁÆÄÂçï' : pkData.task.difficulty === 'medium' ? '‰∏≠Á≠â' : 'Âõ∞Èöæ'} | 
                        Êó∂ÈôêÔºö${pkData.task.timeLimit}ÂàÜÈíü
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="acceptPK()" style="margin-right: 8px;">Êé•ÂèóÊåëÊàò</button>
                    <button class="btn btn-secondary" onclick="ignorePK()">ÂøΩÁï•</button>
                </div>
            `;
            
            pkSection.style.display = 'block';
            
            // 3ÂàÜÈíüÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (gameData.pkChallenge && !gameData.pkChallenge.accepted) {
                    ignorePK();
                }
            }, 3 * 60 * 1000);
        }
        
        function getOpponentIcon(personality) {
            const icons = {
                confident: 'üëë', shy: 'üê∞', aggressive: 'üî•', supportive: 'üåü',
                silent: 'üóø', sarcastic: 'üòè', cheerful: 'üòä', competitive: '‚öîÔ∏è',
                genius: 'üß†', persistent: 'üí™', efficient: '‚ö°', night_owl: 'ü¶â'
            };
            return icons[personality] || 'üéØ';
        }
        
        async function acceptPK() {
            if (!gameData.pkChallenge) return;
            
            gameData.pkChallenge.accepted = true;
            gameData.pkChallenge.acceptedTime = new Date().toISOString();
            
            showNotification('PKÊåëÊàòÂ∑≤Êé•ÂèóÔºÅÊ≠£Âú®ËøõË°åÊøÄÁÉàÂØπÊàò...');
            document.getElementById('pkSection').style.display = 'none';
            
            // Ê®°ÊãüPKÁªìÊûúÔºàÂü∫‰∫éÂ§öÁßçÂõ†Á¥†Ôºâ
            setTimeout(async () => {
                await resolvePK();
            }, 2000); // 2ÁßíÂêéÊòæÁ§∫ÁªìÊûú
        }
        
        async function resolvePK() {
            if (!gameData.pkChallenge || !gameData.pkChallenge.accepted) return;
            
            const opponent = gameData.pkChallenge.opponent;
            const task = gameData.pkChallenge.task;
            
            // ËÆ°ÁÆóËÉúË¥üÊ¶ÇÁéáÔºàÂü∫‰∫éÂ§öÁßçÂõ†Á¥†Ôºâ
            let userWinChance = 0.4; // Âü∫Á°Ä40%ËÉúÁéá
            
            // Âü∫‰∫éÊÆµ‰ΩçÂ∑ÆË∑ùË∞ÉÊï¥
            const userRankValue = getRankValue(gameData.rank.level, gameData.rank.tier, gameData.rank.stars);
            const opponentRankValue = getRankValue(opponent.rankLevel, opponent.tier, opponent.stars);
            const rankDiff = userRankValue - opponentRankValue;
            userWinChance += rankDiff / 1000 * 0.2; // ÊÆµ‰Ωç‰ºòÂäø
            
            // Âü∫‰∫éÂΩìÂâçÁä∂ÊÄÅË∞ÉÊï¥
            userWinChance += gameData.todayPower / 100 * 0.2; // ÊàòÂäõÂä†Êàê
            userWinChance += gameData.streakDays * 0.05; // ËøûËÉúÂä†Êàê
            userWinChance += (gameData.completedTasks.length / Math.max(gameData.tasks.length, 1)) * 0.1; // ÂÆåÊàêÂ∫¶Âä†Êàê
            
            // Âü∫‰∫é‰ªªÂä°ÈöæÂ∫¶Ë∞ÉÊï¥
            if (task.difficulty === 'easy') userWinChance += 0.1;
            else if (task.difficulty === 'hard') userWinChance -= 0.1;
            
            // Âü∫‰∫éÂÖ≥Á≥ªË∞ÉÊï¥
            if (opponent.relationshipWithUser > 0.5) userWinChance += 0.05; // ÂèãÂ•ΩÂÖ≥Á≥ªÔºåÂØπÊñπÂèØËÉΩËÆ©ÁùÄ
            else if (opponent.relationshipWithUser < -0.5) userWinChance -= 0.05; // ÊïåÂØπÂÖ≥Á≥ªÔºåÂØπÊñπÊõ¥Êãº
            
            // Âü∫‰∫éÂ≠¶‰π†Êó∂Á®ãË∞ÉÊï¥
            const currentSchedule = getCurrentScheduleInfo();
            if (currentSchedule.type === 'study' && currentSchedule.efficiency >= 1.0) {
                userWinChance += 0.1; // Â≠¶‰π†Êó∂Èó¥ÊÆµÂä†Êàê
            }
            
            // ÈôêÂà∂Âú®10%-90%‰πãÈó¥
            userWinChance = Math.max(0.1, Math.min(0.9, userWinChance));
            
            const random = Math.random();
            let result, resultText, rewardText = '';
            
            if (random < userWinChance) {
                // ËÉúÂà©
                result = 'win';
                resultText = 'üéâ ËÉúÂà©ÔºÅ';
                gameData.stats.pkWins++;
                gameData.rank.stars = Math.min(5, gameData.rank.stars + 1);
                gameData.ranking = Math.max(1, gameData.ranking - Math.floor(Math.random() * 20) - 5);
                
                // ËÉúÂà©Â•ñÂä±
                const winRewards = ['ÊäΩÂç°Âà∏√ó2', 'ÂèåÂÄçÁªèÈ™åÂç°(6Â∞èÊó∂)', 'Â®ÅÊúõ‰ª§Áâå'];
                const reward = winRewards[Math.floor(Math.random() * winRewards.length)];
                gameData.inventory.push({ type: 'virtual', name: reward });
                rewardText = `Ëé∑ÂæóÂ•ñÂä±Ôºö${reward}`;
                
                // ÊîπÂñÑÂÖ≥Á≥ª
                opponent.relationshipWithUser += 0.1;
                
            } else if (random < userWinChance + 0.15) {
                // Âπ≥Â±Ä
                result = 'draw';
                resultText = 'ü§ù Âπ≥Â±ÄÔºÅ';
                gameData.stats.pkDraws++;
                
                // Âπ≥Â±ÄÂ∞èÂ•ñÂä±
                gameData.inventory.push({ type: 'virtual', name: 'ÊäΩÂç°Âà∏√ó1' });
                rewardText = 'Ëé∑ÂæóÂÆâÊÖ∞Â•ñÔºöÊäΩÂç°Âà∏√ó1';
                
            } else {
                // Â§±Ë¥•
                result = 'loss';
                resultText = 'üòî Â§±Ë¥•...';
                gameData.stats.pkLosses++;
                
                // Â§±Ë¥•ÊÉ©ÁΩö
                if (gameData.rank.stars > 1) {
                    gameData.rank.stars--;
                } else if (gameData.rank.tier < 5) {
                    gameData.rank.stars = 5;
                    gameData.rank.tier++;
                }
                gameData.ranking = Math.min(10000, gameData.ranking + Math.floor(Math.random() * 15) + 5);
                
                // ÊÅ∂ÂåñÂÖ≥Á≥ª
                opponent.relationshipWithUser -= 0.05;
            }
            
            // ËÆ∞ÂΩïPKÂéÜÂè≤
            gameData.pkHistory.unshift({
                opponent: opponent.name,
                result: result,
                task: task.task,
                date: new Date().toISOString()
            });
            
            // ‰øùÊåÅÊúÄËøë10Ê¨°ËÆ∞ÂΩï
            if (gameData.pkHistory.length > 10) {
                gameData.pkHistory = gameData.pkHistory.slice(0, 10);
            }
            
            // ÊòæÁ§∫ÁªìÊûúÔºàÂºÇÊ≠•Ôºâ
            await showPKResult(resultText, rewardText, opponent);
            
            // Ê∏ÖÈô§PKÊåëÊàò
            gameData.pkChallenge = null;
            
            updateUI();
            saveData();
        }
        
        async function showPKResult(resultText, rewardText, opponent) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const resultColor = resultText.includes('ËÉúÂà©') ? '#10b981' : 
                               resultText.includes('Âπ≥Â±Ä') ? '#f59e0b' : '#ef4444';
            
            // ‰ΩøÁî®AIÁîüÊàêÂØπÊâãÂèçÂ∫î
            const resultType = resultText.includes('ËÉúÂà©') ? 'user_win' : 
                              resultText.includes('Âπ≥Â±Ä') ? 'draw' : 'user_loss';
            
            let reaction = 'Â•ΩÁöÑÊØîËµõÔºÅ';
            try {
                const reactions = await getPostBattleReaction(opponent.personality, resultType, opponent.name);
                reaction = reactions[0];
            } catch (error) {
                console.error('AIÂèçÂ∫îÁîüÊàêÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂèçÂ∫î');
                const fallbackReactions = getFallbackReactions(opponent.personality, resultType);
                reaction = fallbackReactions[Math.floor(Math.random() * fallbackReactions.length)];
            }
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header" style="background: ${resultColor}; color: white;">
                        PKÁªìÊûú
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <div style="font-size: 24px; margin: 20px 0;">${resultText}</div>
                        <div style="margin: 15px 0; padding: 10px; background: #f1f5f9; border-radius: 8px;">
                            <strong>${opponent.name}Ôºö</strong>"${reaction}"
                        </div>
                        ${rewardText ? `<div style="color: #059669; margin: 10px 0;">üéÅ ${rewardText}</div>` : ''}
                        <div style="font-size: 12px; color: #6b7280; margin-top: 10px;">
                            üí° ÂØπËØùÁî±Ë±ÜÂåÖAIÂÆûÊó∂ÁîüÊàê
                        </div>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Á°ÆÂÆö</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function getPostBattleReaction(personality, result) {
            const reactions = {
                confident: {
                    user_win: ['‰∏çÈîôÂòõÔºåËøôÊ¨°ÁÆó‰Ω†Ëµ¢‰∫ÜÔºÅ', 'Ê≤°ÊÉ≥Âà∞‰Ω†ËøòÊå∫ÊúâÂÆûÂäõÁöÑ', '‰∏ãÊ¨°Êàë‰∏ç‰ºöÂÜçËæì‰∫ÜÔºÅ'],
                    draw: ['ÂäøÂùáÂäõÊïåÔºåÊúâË∂£ÔºÅ', 'ËøôÊ¨°ÁÆóÂπ≥ÊâãÂêß', 'ÁúãÊù•Êàë‰ª¨ÂÆûÂäõÂ∑Æ‰∏çÂ§öÂë¢'],
                    user_loss: ['ÂìàÂìàÔºåÊàëÂ∞±ËØ¥ÂòõÔºÅ', 'ËøôÊâçÊòØÊ≠£Â∏∏ÁªìÊûú', 'ÊàëÁöÑÂÆûÂäõ‰Ω†ËøòÊòØÁúãÊ∏ÖÊ•ö‰∫ÜÂêß']
                },
                shy: {
                    user_win: ['‰Ω†Â•ΩÂéâÂÆ≥...', 'ÊàëËøòÈúÄË¶ÅÂ§öÂä™Âäõ...', 'ÊÅ≠Âñú‰Ω†...'],
                    draw: ['Êàë‰ª¨ÈÉΩÂæàÂä™ÂäõÂë¢...', 'Â§ßÂÆ∂ÈÉΩÂä†Ê≤π...', '‰∏ãÊ¨°ÁªßÁª≠Âä™Âäõ...'],
                    user_loss: ['‰∏çÂ•ΩÊÑèÊÄù...', 'ÊàëËøôÊ¨°ËøêÊ∞îÊØîËæÉÂ•Ω...', '‰Ω†Â∑≤ÁªèÂæàÊ£í‰∫Ü...']
                },
                aggressive: {
                    user_win: ['ÂèØÊÅ∂ÔºÅ‰∏ãÊ¨°Êàë‰∏ÄÂÆöË¶ÅËµ¢ÂõûÊù•ÔºÅ', 'ËøôÊ¨°ÁÆó‰Ω†ËøêÊ∞îÂ•ΩÔºÅ', 'ÊàëÁªù‰∏ç‰ºöËÆ§ËæìÁöÑÔºÅ'],
                    draw: ['ÂàáÔºåËøôÊ¨°Â∞±ÁÆóÂπ≥ÊâãÂêßÔºÅ', '‰∏ãÊ¨°ÊàëË¶ÅÂΩªÂ∫ïÂáªË¥•‰Ω†ÔºÅ', 'ËøòÁÆóÂáëÂêàÂêß'],
                    user_loss: ['ÂìàÔºÅÊàëÂ∞±Áü•ÈÅì‰Ω†‰∏çË°åÔºÅ', 'ËøôÂ∞±ÊòØÂÆûÂäõÂ∑ÆË∑ùÔºÅ', '‰∏ãÊ¨°ËøòÊï¢Êù•ÂêóÔºü']
                },
                supportive: {
                    user_win: ['Â§™Ê£í‰∫ÜÔºÅ‰Ω†ËøõÊ≠•ÂæàÂ§ßÔºÅ', 'Áúü‰∏∫‰Ω†È´òÂÖ¥ÔºÅ', '‰Ω†ÁöÑÂä™ÂäõÂæóÂà∞‰∫ÜÂõûÊä•ÔºÅ'],
                    draw: ['Êàë‰ª¨ÈÉΩÂæàÊ£íÔºÅ', 'ÁªßÁª≠‰øùÊåÅËøô‰∏™Áä∂ÊÄÅÔºÅ', '‰∏ÄËµ∑Âä†Ê≤πÔºÅ'],
                    user_loss: ['Âà´ÁÅ∞ÂøÉÔºå‰Ω†Â∑≤ÁªèÂÅöÂæóÂæàÂ•Ω‰∫ÜÔºÅ', '‰∏ãÊ¨°‰∏ÄÂÆöÂèØ‰ª•ÁöÑÔºÅ', 'Â§±Ë¥•ÊòØÊàêÂäü‰πãÊØçÔºÅ']
                },
                silent: {
                    user_win: ['...ÔºàÁÇπÂ§¥Ë°®Á§∫ËÆ§ÂèØÔºâ', 'ÔºàÊ≤âÈªòÂú∞ÈºìÊéåÔºâ', '...'],
                    draw: ['...ÔºàÊè°ÊâãÔºâ', 'ÔºàÁÇπÂ§¥Ôºâ', '...'],
                    user_loss: ['...ÔºàÊ∑°ÁÑ∂Âú∞Á¶ªÂºÄÔºâ', 'ÔºàÈªòÈªòÊî∂Êãæ‰∏úË•øÔºâ', '...']
                }
            };
            
            return reactions[personality]?.[result] || ['Â•ΩÁöÑÊØîËµõÔºÅ', '‰∏ãÊ¨°ÂÜçÊù•ÔºÅ', 'ÁªßÁª≠Âä™ÂäõÔºÅ'];
        }
        
        function ignorePK() {
            if (gameData.pkChallenge) {
                const opponent = gameData.pkChallenge.opponent;
                // ÂøΩÁï•PK‰ºöËΩªÂæÆÊÅ∂ÂåñÂÖ≥Á≥ª
                opponent.relationshipWithUser -= 0.02;
                
                gameData.pkChallenge = null;
                showNotification('Â∑≤ÂøΩÁï•PKÊåëÊàò');
            }
            document.getElementById('pkSection').style.display = 'none';
        }
        
        function checkDailyReset() {
            const today = new Date().toDateString();
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÂ§©
            if (gameData.lastLoginDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toDateString();
                
                // Â¶ÇÊûúÊò®Â§©Êúâ‰ªªÂä°‰ΩÜÊú™ÂÆåÊàêÔºåËøõË°åÊÉ©ÁΩö
                if (gameData.lastTaskDate === yesterdayString) {
                    const completionRate = gameData.completedTasks.length / Math.max(gameData.tasks.length, 1);
                    
                    if (completionRate < 0.6) { // ÂÆåÊàêÂ∫¶‰Ωé‰∫é60%
                        applyDailyPenalty(completionRate);
                    } else if (completionRate >= 0.8) { // ÂÆåÊàêÂ∫¶80%‰ª•‰∏ä
                        applyDailyBonus(completionRate);
                    }
                    
                    // Êõ¥Êñ∞ËøûÁª≠ÂÆåÊàêÂ§©Êï∞
                    if (completionRate >= 0.7) {
                        gameData.streakDays++;
                    } else {
                        gameData.streakDays = 0;
                    }
                } else if (gameData.lastTaskDate && gameData.lastTaskDate < yesterdayString) {
                    // Êò®Â§©Ê≤°Êúâ‰ªªÂä°ÔºàÊñ≠Á≠æÔºâ
                    gameData.streakDays = 0;
                    showNotification('‚ö†Ô∏è Êò®Â§©Ê≤°ÊúâÂ≠¶‰π†‰ªªÂä°ÔºåËøûÁª≠ÂÆåÊàêÂ§©Êï∞ÈáçÁΩÆÔºÅ', 'error');
                }
                
                // ÈáçÁΩÆÂΩìÂ§©Êï∞ÊçÆ
                gameData.todayPower = 0;
                gameData.completedTasks = [];
                gameData.tasks = [];
                gameData.lastLoginDate = today;
                
                // ËôöÊãüÁé©ÂÆ∂Áä∂ÊÄÅÊõ¥Êñ∞
                updateVirtualPlayers();
                
                // ÈöèÊú∫ÊîπÂèòÂç∑Âç∑ÂøÉÊÉÖ
                const moods = ['happy', 'hungry', 'sleepy', 'excited'];
                gameData.catMood = moods[Math.floor(Math.random() * moods.length)];
                
                saveData();
                showDailyReport();
            }
        }
        
        function applyDailyPenalty(completionRate) {
            const penaltyLevel = completionRate < 0.3 ? 'severe' : completionRate < 0.6 ? 'moderate' : 'light';
            
            let penaltyText = '';
            
            switch (penaltyLevel) {
                case 'severe':
                    // ‰∏•ÈáçÊÉ©ÁΩöÔºöÊéâ2Êòü + ÊéíÂêç‰∏ãÈôç
                    if (gameData.rank.stars >= 2) {
                        gameData.rank.stars -= 2;
                    } else {
                        gameData.rank.stars = 5 - (2 - gameData.rank.stars);
                        if (gameData.rank.tier < 5) {
                            gameData.rank.tier++;
                        } else {
                            const rankOrder = ['king', 'master', 'diamond', 'platinum', 'gold', 'silver', 'bronze'];
                            const currentIndex = rankOrder.indexOf(gameData.rank.level);
                            if (currentIndex < rankOrder.length - 1) {
                                gameData.rank.level = rankOrder[currentIndex + 1];
                                gameData.rank.tier = 1;
                            }
                        }
                    }
                    gameData.ranking = Math.min(10000, gameData.ranking + Math.floor(Math.random() * 200) + 100);
                    penaltyText = 'üò± ‰∏•ÈáçÊÉ©ÁΩöÔºöÊéâËêΩ2ÊòüÔºåÊéíÂêçÂ§ßÂπÖ‰∏ãÈôçÔºÅ';
                    gameData.catMood = 'sad';
                    break;
                    
                case 'moderate':
                    // ‰∏≠Á≠âÊÉ©ÁΩöÔºöÊéâ1Êòü
                    if (gameData.rank.stars > 1) {
                        gameData.rank.stars--;
                    } else {
                        gameData.rank.stars = 5;
                        if (gameData.rank.tier < 5) {
                            gameData.rank.tier++;
                        }
                    }
                    gameData.ranking = Math.min(10000, gameData.ranking + Math.floor(Math.random() * 100) + 50);
                    penaltyText = 'üòî ‰∏≠Á≠âÊÉ©ÁΩöÔºöÊéâËêΩ1ÊòüÔºåÊéíÂêç‰∏ãÈôçÔºÅ';
                    gameData.catMood = 'disappointed';
                    break;
                    
                case 'light':
                    // ËΩªÂæÆÊÉ©ÁΩöÔºöÊéíÂêçÂ∞èÂπÖ‰∏ãÈôç
                    gameData.ranking = Math.min(10000, gameData.ranking + Math.floor(Math.random() * 50) + 20);
                    penaltyText = 'üòê ËΩªÂæÆÊÉ©ÁΩöÔºöÊéíÂêçÂ∞èÂπÖ‰∏ãÈôç';
                    break;
            }
            
            showNotification(penaltyText, 'error');
        }
        
        function applyDailyBonus(completionRate) {
            let bonusText = '';
            
            if (completionRate >= 0.95) {
                // ÂÆåÁæéÂÆåÊàêÔºöÈ¢ùÂ§ñÂ•ñÂä±
                gameData.rank.stars = Math.min(5, gameData.rank.stars + 1);
                gameData.ranking = Math.max(1, gameData.ranking - Math.floor(Math.random() * 50) - 20);
                
                // ÂÆåÁæéÂÆåÊàêÂ•ñÂä±
                const perfectRewards = [
                    { type: 'costume', name: 'Âç∑Âç∑„ÄêÂÆåÁæé‰∏ª‰πâËÄÖÂæΩÁ´†„ÄëË£ÖÊâÆ', costume: 'ÂÆåÁæé‰∏ª‰πâËÄÖÁöÑÈáëËâ≤ÂæΩÁ´†' },
                    { type: 'virtual', name: 'ÂÆåÁæéÂÆåÊàêÂ•ñÁ´†√ó1' },
                    { type: 'virtual', name: 'ÊäΩÂç°Âà∏√ó3' }
                ];
                const reward = perfectRewards[Math.floor(Math.random() * perfectRewards.length)];
                gameData.inventory.push(reward);
                
                bonusText = `üåü ÂÆåÁæéÂÆåÊàêÔºÅËé∑Âæó1Êòü+ÊéíÂêçÊèêÂçá+${reward.name}ÔºÅ`;
                gameData.catMood = 'excited';
                
            } else if (completionRate >= 0.8) {
                // ‰ºòÁßÄÂÆåÊàêÔºöÂ∞èÂπÖÂ•ñÂä±
                gameData.ranking = Math.max(1, gameData.ranking - Math.floor(Math.random() * 30) - 10);
                gameData.inventory.push({ type: 'virtual', name: 'ÊäΩÂç°Âà∏√ó1' });
                
                bonusText = '‚ú® ‰ºòÁßÄÂÆåÊàêÔºÅÊéíÂêçÊèêÂçá+ÊäΩÂç°Âà∏√ó1ÔºÅ';
                gameData.catMood = 'happy';
            }
            
            if (bonusText) {
                showNotification(bonusText);
            }
        }
        
        function showDailyReport() {
            if (gameData.streakDays > 0 || gameData.stats.totalTasksCompleted > 0) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                
                const streakText = gameData.streakDays > 0 ? 
                    `üî• ËøûÁª≠ÂÆåÊàêÔºö${gameData.streakDays}Â§©` : 
                    'üíî ËøûÁª≠ÂÆåÊàêÂ∑≤‰∏≠Êñ≠';
                    
                const rankText = `${['ÈùíÈìú', 'ÁôΩÈì∂', 'ÈªÑÈáë', 'ÈìÇÈáë', 'ÈíªÁü≥', 'ÊòüËÄÄ', 'ÁéãËÄÖ'][['bronze', 'silver', 'gold', 'platinum', 'diamond', 'master', 'king'].indexOf(gameData.rank.level)]}${'‚Ö†‚Ö°‚Ö¢‚Ö£‚Ö§'[gameData.rank.tier-1]} ${'‚òÖ'.repeat(gameData.rank.stars)}${'‚òÜ'.repeat(5-gameData.rank.stars)}`;
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;">
                            üìä ÊØèÊó•ÊÄªÁªì
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 18px; margin-bottom: 10px;">üåÖ Êñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫ÜÔºÅ</div>
                                <div style="margin: 10px 0;">${streakText}</div>
                                <div style="margin: 10px 0;">üèÜ ÂΩìÂâçÊÆµ‰ΩçÔºö${rankText}</div>
                                <div style="margin: 10px 0;">üìà ÂΩìÂâçÊéíÂêçÔºöÁ¨¨${gameData.ranking}Âêç</div>
                                <div style="margin: 10px 0;">üìö Á¥ØËÆ°ÂÆåÊàêÔºö${gameData.stats.totalTasksCompleted}‰∏™‰ªªÂä°</div>
                                ${gameData.streakDays >= 7 ? '<div style="color: #10b981; margin: 10px 0;">üéâ ËøûÁª≠ÂÆåÊàê‰∏ÄÂë®ÔºÅËé∑ÂæóÁâπÊÆäÂ•ñÂä±ÔºÅ</div>' : ''}
                            </div>
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">ÂºÄÂßãÊñ∞‰∏ÄÂ§©ÁöÑÂ≠¶‰π†ÔºÅ</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ËøûÁª≠ÂÆåÊàê‰∏ÄÂë®ÁöÑÁâπÊÆäÂ•ñÂä±
                if (gameData.streakDays >= 7 && gameData.streakDays % 7 === 0) {
                    gameData.inventory.push({
                        type: 'costume',
                        name: 'Âç∑Âç∑„Äê‰∏ÉÊó•ËææÊàêËÄÖ„ÄëË£ÖÊâÆ',
                        costume: 'Ë±°ÂæÅ‰∏ÉÊó•ÂùöÊåÅÁöÑÂΩ©ËôπÂõ¥Â∑æ'
                    });
                    
                    // Êúâ5%Ê¶ÇÁéáËé∑ÂæóÁé∞ÂÆûÂ•ñÂä±
                    if (Math.random() < 0.05) {
                        const realReward = REWARD_LIBRARY.realRewards[Math.floor(Math.random() * REWARD_LIBRARY.realRewards.length)];
                        gameData.inventory.push({
                            type: 'real',
                            name: realReward
                        });
                        showNotification(`üéÅ ËøûÁª≠ÂÆåÊàê‰∏ÄÂë®ÁâπÊÆäÂ•ñÂä±Ôºö${realReward}ÔºÅ`);
                    }
                }
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function claimReward(reward) {
            gameData.inventory.push({ name: reward });
            showNotification(`üéÅ ${reward} Â∑≤ÊîæÂÖ•‰ªìÂ∫ìÔºÅ`);
            saveData();
        }
        
        function showInventory() {
            let inventoryHTML = gameData.inventory.length === 0 
                ? '‰ªìÂ∫ìÁ©∫Á©∫Â¶Ç‰πü...' 
                : gameData.inventory.map(item => `
                    <div style="padding: 8px; margin: 4px 0; background: #f8fafc; border-radius: 6px;">
                        ${item.name}
                    </div>
                `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">üì¶ ÊàëÁöÑ‰ªìÂ∫ì</div>
                    <div class="modal-body">
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${inventoryHTML}
                        </div>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.id === 'taskInput') {
                completeTask();
            }
            if (e.key === 'Enter' && e.target.id === 'aiInput') {
                sendToAI();
            }
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });
        
        // Ê≥®ÂÜåService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")')
                    .then(() => console.log('SW registered'))
                    .catch(() => console.log('SW registration failed'));
            });
        }
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupFileUpload();
        });
    </script>
</body>
</html>